name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: 测试
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22']

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Go
      uses: actions/setup-go@v5
      with:
        go-version: \${{ matrix.go-version }}

    - name: 安装依赖
      run: go mod download

    - name: 格式化检查
      run: |
        gofmt -l . | tee /tmp/fmt.txt
        if [ -s /tmp/fmt.txt ]; then
          echo "代码格式不规范"
          cat /tmp/fmt.txt
          exit 1
        fi

    - name: 运行测试
      run: go test -v -race -coverprofile=coverage.out ./...

  build:
    name: 构建
    needs: test
    runs-on: \${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        go-version: ['1.21']

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Go
      uses: actions/setup-go@v5
      with:
        go-version: \${{ matrix.go-version }}

    - name: 构建
      run: |
        go build -v -o bin/agentflow ./cmd/agentflow
        go build -v -o bin/master ./cmd/master
        go build -v -o bin/worker ./cmd/worker
