version: '3.8'

services:
  # Master Server
  master:
    build:
      context: ../..
      dockerfile: deployment/nodejs/Dockerfile
    container_name: agentflow-master
    ports:
      - "6767:6767"
    environment:
      - NODE_ENV=production
      - AGENTFLOW_MASTER_URL=http://localhost:6767
    volumes:
      - agentflow-data:/data
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - agentflow-network

  # Worker 1
  worker-1:
    build:
      context: ../..
      dockerfile: deployment/nodejs/Dockerfile
    container_name: agentflow-worker-1
    command: node /app/packages/worker/dist/index.js
    environment:
      - NODE_ENV=production
      - AGENTFLOW_MASTER_URL=http://master:6767
      - AGENTFLOW_GROUP=docker
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      master:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - agentflow-network

  # Worker 2 (Auto-scaling)
  worker-2:
    build:
      context: ../..
      dockerfile: deployment/nodejs/Dockerfile
    container_name: agentflow-worker-2
    command: node /app/packages/worker/dist/index.js
    environment:
      - NODE_ENV=production
      - AGENTFLOW_MASTER_URL=http://master:6767
      - AGENTFLOW_GROUP=docker
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      master:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - agentflow-network

  # Admin UI (Optional - using nginx/reqresend for API testing)
  admin:
    image: nginx:alpine
    container_name: agentflow-admin
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - master
    restart: unless-stopped
    networks:
      - agentflow-network

volumes:
  agentflow-data:
    driver: local

networks:
  agentflow-network:
    driver: bridge
