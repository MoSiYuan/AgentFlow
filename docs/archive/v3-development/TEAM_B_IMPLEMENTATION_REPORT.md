# Team B å®ç°æ€»ç»“æŠ¥å‘Š

## æ¦‚è¿°

Team B è´Ÿè´£å®ç°è®°å¿†ä¸å®‰å…¨æ¨¡å—ï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

1. **memory/mod.rs** - è®°å¿†æ ¸å¿ƒç³»ç»Ÿ
2. **sandbox/mod.rs** - æ²™ç®±å®‰å…¨æ§åˆ¶
3. **executor/prompt_builder.rs** - Prompt æ„å»ºå™¨

---

## 1. memory/mod.rs - è®°å¿†æ ¸å¿ƒç³»ç»Ÿ

### æ–‡ä»¶è·¯å¾„
`/Users/jiangxiaolong/work/project/AgentFlow/rust/agentflow-core/src/memory/mod.rs`

### æ ¸å¿ƒç»“æ„

#### MemoryCore
```rust
pub struct MemoryCore {
    pool: SqlitePool,  // SQLite è¿æ¥æ± 
}
```

### ä¸»è¦åŠŸèƒ½

#### 1.1 åˆå§‹åŒ–
- **`MemoryCore::new(db_path: &str) -> Result<Self>`**
  - åˆ›å»º SQLite æ•°æ®åº“è¿æ¥
  - è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
  - è®¾ç½®ç´¢å¼•ï¼ˆkey, category, task_id, timestampï¼‰

#### 1.2 è®°å¿†ç´¢å¼•
- **`index(&self, entry: &MemoryEntry) -> Result<()>`**
  - å°†è®°å¿†æ¡ç›®å­˜å‚¨åˆ°æ•°æ®åº“
  - è‡ªåŠ¨ç”Ÿæˆå‘é‡åµŒå…¥ï¼ˆåŸºäºç‰¹å¾å“ˆå¸Œï¼‰
  - æ”¯æŒæ’å…¥æˆ–æ›´æ–°ï¼ˆUPSERTï¼‰
  - å­˜å‚¨ JSON åºåˆ—åŒ–çš„å€¼

#### 1.3 è¯­ä¹‰æ£€ç´¢
- **`search(&self, query: &str, limit: usize) -> Result<Vec<MemoryEntry>>`**
  - æ ¹æ®æŸ¥è¯¢æ–‡æœ¬æ£€ç´¢ç›¸å…³è®°å¿†
  - è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
  - æŒ‰ç›¸ä¼¼åº¦æ’åºè¿”å›ç»“æœ
  - è‡ªåŠ¨è¿‡æ»¤è¿‡æœŸæ¡ç›®

#### 1.4 åŸºç¡€ CRUD æ“ä½œ
- **`get(&self, key: &str) -> Result<Option<MemoryEntry>>`** - æ ¹æ®é”®è·å–å•æ¡è®°å¿†
- **`delete(&self, key: &str) -> Result<()>`** - åˆ é™¤æŒ‡å®šé”®çš„è®°å¿†
- **`cleanup_expired(&self) -> Result<u64>`** - æ¸…ç†æ‰€æœ‰è¿‡æœŸæ¡ç›®

#### 1.5 ç»Ÿè®¡ä¸ç›‘æ§
- **`stats(&self) -> Result<MemoryStats>`**
  - è¿”å›è®°å¿†åº“ç»Ÿè®¡ä¿¡æ¯
  - æ€»æ¡ç›®æ•°ã€è¿‡æœŸæ¡ç›®æ•°ã€æœ‰æ•ˆæ¡ç›®æ•°

### æŠ€æœ¯å®ç°

#### æ•°æ®åº“è¡¨ç»“æ„
```sql
CREATE TABLE memories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key TEXT NOT NULL UNIQUE,
    value TEXT NOT NULL,
    category TEXT NOT NULL,
    task_id TEXT,
    timestamp INTEGER NOT NULL,
    expires_at INTEGER,
    embedding BLOB,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

#### å‘é‡åµŒå…¥å®ç°
- ä½¿ç”¨ç‰¹å¾å“ˆå¸Œç”Ÿæˆ 256 ç»´å‘é‡
- åŸºäºæ–‡æœ¬å†…å®¹çš„å“ˆå¸Œè®¡ç®—
- ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—

#### æ€§èƒ½ä¼˜åŒ–
- åˆ›å»ºäº† 4 ä¸ªç´¢å¼•ä»¥åŠ é€ŸæŸ¥è¯¢
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥
- æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

### æµ‹è¯•è¦†ç›–
- âœ“ åŸºæœ¬ç´¢å¼•å’Œæ£€ç´¢
- âœ“ è¿‡æœŸæ¡ç›®å¤„ç†
- âœ“ ç›¸ä¼¼åº¦æœç´¢
- âœ“ ç»Ÿè®¡åŠŸèƒ½

---

## 2. sandbox/mod.rs - æ²™ç®±å®‰å…¨æ§åˆ¶

### æ–‡ä»¶è·¯å¾„
`/Users/jiangxiaolong/work/project/AgentFlow/rust/agentflow-core/src/sandbox/mod.rs`

### æ ¸å¿ƒç»“æ„

#### SandboxConfig
```rust
pub struct SandboxConfig {
    allowed_dirs: HashSet<PathBuf>,      // ç™½åå•ç›®å½•
    strict_mode: bool,                    // ä¸¥æ ¼æ¨¡å¼
    allow_symlinks: bool,                 // å…è®¸ç¬¦å·é“¾æ¥
    max_symlink_depth: usize,             // æœ€å¤§ç¬¦å·é“¾æ¥æ·±åº¦
}
```

#### SandboxError
```rust
pub enum SandboxError {
    PathNotAllowed(String),               // è·¯å¾„ä¸åœ¨ç™½åå•
    PathTraversalDetected(String),        // è·¯å¾„ç©¿é€æ”»å‡»
    SymlinkAttack(String),                // ç¬¦å·é“¾æ¥æ”»å‡»
    PathResolutionFailed(String),         // è·¯å¾„è§£æå¤±è´¥
    ValidationFailed(String),             // éªŒè¯å¤±è´¥
}
```

### ä¸»è¦åŠŸèƒ½

#### 2.1 ç™½åå•ç®¡ç†
- **`new()`** - åˆ›å»ºé»˜è®¤é…ç½®
- **`with_allowed_dirs(Vec<PathBuf>)`** - ä½¿ç”¨æŒ‡å®šç™½åå•åˆ›å»º
- **`add_allowed_dir(PathBuf)`** - æ·»åŠ å…è®¸çš„ç›®å½•
- **`remove_allowed_dir(&Path)`** - ç§»é™¤å…è®¸çš„ç›®å½•

#### 2.2 è·¯å¾„éªŒè¯
- **`validate_path(&self, path: &Path) -> Result<(), SandboxError>`**
  - è§„èŒƒåŒ–è·¯å¾„ï¼ˆè§£æ `.` å’Œ `..`ï¼‰
  - æ£€æµ‹è·¯å¾„ç©¿é€æ”»å‡»ï¼ˆ`../` æ¨¡å¼ï¼‰
  - æ£€æŸ¥ç¬¦å·é“¾æ¥æ”»å‡»ï¼ˆé€’å½’æ£€æŸ¥ï¼‰
  - éªŒè¯æ˜¯å¦åœ¨ç™½åå•ä¸­

#### 2.3 æ‰¹é‡éªŒè¯
- **`validate_paths(&self, paths: &[&Path])`**
  - ä¸€æ¬¡æ€§éªŒè¯å¤šä¸ªè·¯å¾„

#### 2.4 å®‰å…¨è·¯å¾„åˆ›å»º
- **`create_safe_path(&self, base_dir, sub_path) -> Result<PathBuf>`**
  - åœ¨ç™½åå•ç›®å½•ä¸‹åˆ›å»ºå®‰å…¨çš„å­è·¯å¾„
  - é˜²æ­¢è·¯å¾„é€ƒé€¸æ”»å‡»
  - ç¡®ä¿ç»“æœä»åœ¨ç™½åå•å†…

#### 2.5 å·¥å…·å‡½æ•°
- **`is_safe_filename(filename: &str) -> bool`**
  - æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦å®‰å…¨
  - æ‹’ç»è·¯å¾„åˆ†éš”ç¬¦ï¼ˆ`/`, `\`ï¼‰
  - æ‹’ç»ç‰¹æ®Šå­—ç¬¦ï¼ˆ`..`, `.`, `~`, `$`ï¼‰

#### 2.6 é…ç½®ç®¡ç†
- **`set_strict_mode(bool)`** - å¯ç”¨/ç¦ç”¨ä¸¥æ ¼æ¨¡å¼
- **`set_allow_symlinks(bool)`** - å…è®¸/ç¦æ­¢ç¬¦å·é“¾æ¥
- **`set_max_symlink_depth(usize)`** - è®¾ç½®æœ€å¤§é€’å½’æ·±åº¦
- **`summary()`** - è·å–é…ç½®æ‘˜è¦

### å®‰å…¨ç‰¹æ€§

#### è·¯å¾„ç©¿é€é˜²æŠ¤
```
æ£€æµ‹æ¨¡å¼:
- "../" (çˆ¶ç›®å½•éå†)
- "..\" (Windows é£æ ¼éå†)
- ä»¥ ".." å¼€å¤´çš„è·¯å¾„ç»„ä»¶
```

#### ç¬¦å·é“¾æ¥é˜²æŠ¤
```
é˜²æŠ¤æœºåˆ¶:
- é€’å½’æ£€æŸ¥ç¬¦å·é“¾æ¥ç›®æ ‡
- é™åˆ¶æœ€å¤§é€’å½’æ·±åº¦ï¼ˆé»˜è®¤ 8ï¼‰
- éªŒè¯ç›®æ ‡æ˜¯å¦åœ¨ç™½åå•å†…
- é˜²æ­¢ç¬¦å·é“¾æ¥å¾ªç¯
```

#### è·¯å¾„è§„èŒƒåŒ–
```
å¤„ç†æµç¨‹:
1. è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
2. è§£ææ‰€æœ‰ç›¸å¯¹ç»„ä»¶
3. è·Ÿéšç¬¦å·é“¾æ¥ï¼ˆå¯é€‰ï¼‰
4. è§„èŒƒåŒ–ä¸ºæ ‡å‡†å½¢å¼
```

### æµ‹è¯•è¦†ç›–
- âœ“ è·¯å¾„ç©¿é€æ£€æµ‹
- âœ“ ç¬¦å·é“¾æ¥æ”»å‡»æ£€æµ‹
- âœ“ ç™½åå•éªŒè¯
- âœ“ å®‰å…¨æ–‡ä»¶åæ£€æŸ¥
- âœ“ å®‰å…¨è·¯å¾„åˆ›å»º

---

## 3. executor/prompt_builder.rs - Prompt æ„å»ºå™¨

### æ–‡ä»¶è·¯å¾„
`/Users/jiangxiaolong/work/project/AgentFlow/rust/agentflow-core/src/executor/prompt_builder.rs`

### æ ¸å¿ƒç»“æ„

#### PromptBuilderConfig
```rust
pub struct PromptBuilderConfig {
    system_instruction: String,      // ç³»ç»ŸæŒ‡ä»¤
    max_tokens: usize,               // æœ€å¤§ token æ•°ï¼ˆé»˜è®¤ 200Kï¼‰
    include_memory: bool,            // åŒ…å«è®°å¿†ä¸Šä¸‹æ–‡
    max_memory_entries: usize,       // æœ€å¤§è®°å¿†æ¡ç›®æ•°
    include_metadata: bool,          // åŒ…å«ä»»åŠ¡å…ƒæ•°æ®
}
```

#### PromptBuilder
```rust
pub struct PromptBuilder {
    config: PromptBuilderConfig,
}
```

### ä¸»è¦åŠŸèƒ½

#### 3.1 åŸºç¡€æ„å»º
- **`new()`** - åˆ›å»ºé»˜è®¤é…ç½®çš„æ„å»ºå™¨
- **`with_config(PromptBuilderConfig)`** - ä½¿ç”¨è‡ªå®šä¹‰é…ç½®

#### 3.2 Prompt æ„å»º

##### ç®€å•æ„å»º
- **`build(&self, task: &str, memories: &[MemoryEntry]) -> String`**
  - ç»„åˆï¼šç³»ç»ŸæŒ‡ä»¤ + è®°å¿†ä¸Šä¸‹æ–‡ + ä»»åŠ¡æè¿°
  - è‡ªåŠ¨å¤„ç† token é™åˆ¶
  - æ™ºèƒ½æˆªæ–­

##### å¸¦å…ƒæ•°æ®æ„å»º
- **`build_with_metadata(&self, task, memories, metadata) -> String`**
  - é¢å¤–åŒ…å«ä»»åŠ¡å…ƒæ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰
  - æ”¯æŒç¯å¢ƒå˜é‡ã€ç‰ˆæœ¬ä¿¡æ¯ç­‰

#### 3.3 Prompt ç»“æ„

```
## ç³»ç»ŸæŒ‡ä»¤
[ç³»ç»ŸæŒ‡ä»¤å†…å®¹]

## ä»»åŠ¡å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰
```json
{å…ƒæ•°æ®}
```

## ç›¸å…³ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
### ä¸Šä¸‹æ–‡ [1]
- **ä»»åŠ¡ID**: xxx
- **å†…å®¹**: xxx

### ä¸Šä¸‹æ–‡ [2]
...

## å½“å‰ä»»åŠ¡
[ä»»åŠ¡æè¿°]
```

#### 3.4 Token ç®¡ç†

##### ä¼°ç®— Token æ•°é‡
- **`estimate_tokens(&self, prompt: &str) -> usize`**
  - ç®€åŒ–ä¼°ç®—ï¼š1 token â‰ˆ 3 å­—ç¬¦
  - è€ƒè™‘ä¸­è‹±æ–‡å·®å¼‚

##### éªŒè¯é•¿åº¦
- **`validate_length(&self, prompt: &str) -> Result<()>`**
  - æ£€æŸ¥æ˜¯å¦è¶…è¿‡ max_tokens
  - è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯

##### è‡ªåŠ¨æˆªæ–­
- **`truncate_if_needed(&self, prompt: &str) -> String`**
  - ä¼˜å…ˆä¿ç•™ï¼šç³»ç»ŸæŒ‡ä»¤ > ä»»åŠ¡ > è®°å¿†
  - å‡å°‘è®°å¿†æ¡ç›®æ•°é‡
  - ç¡®ä¿ä¸è¶…è¿‡ token é™åˆ¶

#### 3.5 é…ç½®ç®¡ç†
- **`config()`** - è·å–å½“å‰é…ç½®
- **`set_config(PromptBuilderConfig)`** - æ›´æ–°é…ç½®

### ä¾¿æ·å‡½æ•°
- **`build_prompt(task: &str, memories: &[MemoryEntry]) -> String`**
  - å¿«é€Ÿæ„å»º Prompt çš„ä¾¿æ·å‡½æ•°
  - ä½¿ç”¨é»˜è®¤é…ç½®

### é«˜çº§ç‰¹æ€§

#### è®°å¿†æ ¼å¼åŒ–
- è‡ªåŠ¨è¯†åˆ«ä¸åŒçš„è®°å¿†ç±»å‹
- æ ¼å¼åŒ– JSON å€¼
- æ·»åŠ åˆ†ç±»æ ‡ç­¾ï¼ˆæ‰§è¡Œè®°å½•ã€ä¸Šä¸‹æ–‡ã€ç»“æœã€é”™è¯¯ã€æ£€æŸ¥ç‚¹ï¼‰

#### æ™ºèƒ½æˆªæ–­ç­–ç•¥
```
ä¼˜å…ˆçº§:
1. ç³»ç»ŸæŒ‡ä»¤ï¼ˆå¿…é¡»ä¿ç•™ï¼‰
2. ä»»åŠ¡æè¿°ï¼ˆå¿…é¡»ä¿ç•™ï¼‰
3. è®°å¿†ä¸Šä¸‹æ–‡ï¼ˆå¯éƒ¨åˆ†ä¿ç•™ï¼‰
   - ä¼˜å…ˆä¿ç•™æœ€æ–°çš„è®°å¿†
   - å‡å°‘æ¡ç›®æ•°é‡
```

#### å…ƒæ•°æ®æ”¯æŒ
- JSON æ ¼å¼çš„å…ƒæ•°æ®
- ç¯å¢ƒä¿¡æ¯ã€ç‰ˆæœ¬å·ç­‰
- å¯é€‰å¯ç”¨/ç¦ç”¨

### é»˜è®¤ç³»ç»ŸæŒ‡ä»¤

åŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š
1. **å®‰å…¨ç¬¬ä¸€** - éªŒè¯æ“ä½œå®‰å…¨æ€§
2. **æ˜ç¡®æ²Ÿé€š** - æ¸…æ™°è¯´æ˜ç†è§£
3. **é€æ­¥æ‰§è¡Œ** - åˆ†è§£å¤æ‚ä»»åŠ¡
4. **éªŒè¯ç»“æœ** - ç¡®ä¿æ­£ç¡®å®Œæˆ

### æµ‹è¯•è¦†ç›–
- âœ“ åŸºæœ¬æ„å»ºåŠŸèƒ½
- âœ“ è®°å¿†ä¸Šä¸‹æ–‡åŒ…å«
- âœ“ å…ƒæ•°æ®æ”¯æŒ
- âœ“ Token æˆªæ–­
- âœ“ Token ä¼°ç®—
- âœ“ é•¿åº¦éªŒè¯

---

## é›†æˆä¸ä¾èµ–

### æ¨¡å—ä¾èµ–å…³ç³»

```
lib.rs
â”œâ”€â”€ types.rs (åŸºç¡€ç±»å‹)
â”œâ”€â”€ memory/mod.rs (ä½¿ç”¨ MemoryEntry, MemoryCategory)
â”œâ”€â”€ sandbox/mod.rs (ç‹¬ç«‹æ¨¡å—)
â””â”€â”€ executor/
    â”œâ”€â”€ mod.rs (TaskExecutor)
    â””â”€â”€ prompt_builder.rs (ä½¿ç”¨ MemoryEntry)
```

### å¤–éƒ¨ä¾èµ–

- **sqlx** - SQLite æ•°æ®åº“æ“ä½œ
- **anyhow** - é”™è¯¯å¤„ç†
- **thiserror** - è‡ªå®šä¹‰é”™è¯¯ç±»å‹
- **serde/serde_json** - JSON åºåˆ—åŒ–
- **tracing** - æ—¥å¿—è®°å½•
- **tokio** - å¼‚æ­¥è¿è¡Œæ—¶

---

## æ–‡ä»¶ç»“æ„

```
rust/agentflow-core/src/
â”œâ”€â”€ lib.rs                          # åº“æ ¹ï¼Œå¯¼å‡ºæ‰€æœ‰æ¨¡å—
â”œâ”€â”€ types.rs                        # å…±äº«ç±»å‹å®šä¹‰
â”œâ”€â”€ memory/
â”‚   â””â”€â”€ mod.rs                      # è®°å¿†æ ¸å¿ƒç³»ç»Ÿ (467 è¡Œ)
â”œâ”€â”€ sandbox/
â”‚   â””â”€â”€ mod.rs                      # æ²™ç®±å®‰å…¨æ§åˆ¶ (445 è¡Œ)
â””â”€â”€ executor/
    â”œâ”€â”€ mod.rs                      # æ‰§è¡Œå™¨æ¨¡å—ï¼ˆå·²æ›´æ–°å¯¼å‡ºï¼‰
    â”œâ”€â”€ killer.rs                   # è¿›ç¨‹ç®¡ç†å™¨ï¼ˆå·²å­˜åœ¨ï¼‰
    â””â”€â”€ prompt_builder.rs           # Prompt æ„å»ºå™¨ (490 è¡Œ)
```

---

## ä»£ç ç»Ÿè®¡

### æ–°å¢ä»£ç 

| æ¨¡å— | æ–‡ä»¶ | è¡Œæ•° | å‡½æ•°æ•° | ç»“æ„ä½“æ•° |
|------|------|------|--------|----------|
| memory | mod.rs | 467 | 13 | 2 |
| sandbox | mod.rs | 445 | 17 | 3 |
| executor | prompt_builder.rs | 490 | 15 | 2 |
| **æ€»è®¡** | **3 æ–‡ä»¶** | **1402** | **45** | **7** |

### å…¬å…± API

#### memory æ¨¡å—
- `MemoryCore` ç»“æ„ä½“
- `MemoryStats` ç»“æ„ä½“
- 13 ä¸ªå…¬å…±æ–¹æ³•

#### sandbox æ¨¡å—
- `SandboxConfig` ç»“æ„ä½“
- `SandboxError` æšä¸¾
- `SandboxSummary` ç»“æ„ä½“
- 17 ä¸ªå…¬å…±æ–¹æ³•
- 1 ä¸ªå…¬å…±é™æ€æ–¹æ³•

#### executor æ¨¡å—
- `PromptBuilder` ç»“æ„ä½“
- `PromptBuilderConfig` ç»“æ„ä½“
- 15 ä¸ªå…¬å…±æ–¹æ³•
- 1 ä¸ªå…¬å…±ä¾¿æ·å‡½æ•°

---

## å…³é”®è®¾è®¡å†³ç­–

### 1. è®°å¿†ç³»ç»Ÿ

#### SQLite å‘é‡ç´¢å¼•
- **å†³ç­–**: ä½¿ç”¨ SQLite + è‡ªå®šä¹‰åµŒå…¥å‘é‡
- **åŸå› **: é›¶ä¾èµ–ã€ç®€å•å¯é ã€é€‚åˆä¸­å°è§„æ¨¡
- **æƒè¡¡**: æ€§èƒ½ä¸å¦‚ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼Œä½†æ»¡è¶³éœ€æ±‚

#### åµŒå…¥ç®—æ³•
- **å†³ç­–**: åŸºäºç‰¹å¾å“ˆå¸Œçš„ç®€åŒ–å®ç°
- **åŸå› **: é¿å…ä¾èµ–å¤§å‹ ML åº“
- **æœªæ¥**: å¯æ›¿æ¢ä¸ºä¸“ç”¨åµŒå…¥æ¨¡å‹ï¼ˆOpenAI embeddingsï¼‰

### 2. æ²™ç®±ç³»ç»Ÿ

#### ç™½åå• vs é»‘åå•
- **å†³ç­–**: ä½¿ç”¨ç™½åå•æœºåˆ¶
- **åŸå› **: æ›´å®‰å…¨ï¼Œé»˜è®¤æ‹’ç»
- **æƒè¡¡**: éœ€è¦æ˜ç¡®é…ç½®å…è®¸çš„ç›®å½•

#### ç¬¦å·é“¾æ¥å¤„ç†
- **å†³ç­–**: é»˜è®¤ç¦æ­¢ï¼Œå¯é…ç½®å…è®¸
- **åŸå› **: é˜²æ­¢ç¬¦å·é“¾æ¥æ”»å‡»
- **å®‰å…¨**: é™åˆ¶é€’å½’æ·±åº¦é˜²æ­¢å¾ªç¯

### 3. Prompt æ„å»ºå™¨

#### Token ä¼°ç®—
- **å†³ç­–**: ç®€åŒ–ä¼°ç®—ï¼ˆ1 token â‰ˆ 3 å­—ç¬¦ï¼‰
- **åŸå› **: é¿å…ä¾èµ–å¤æ‚çš„ tokenizer
- **æƒè¡¡**: ä¸å¤Ÿç²¾ç¡®ï¼Œä½†å¯¹æˆªæ–­è¶³å¤Ÿ

#### æˆªæ–­ç­–ç•¥
- **å†³ç­–**: ä¼˜å…ˆä¿ç•™ç³»ç»ŸæŒ‡ä»¤å’Œä»»åŠ¡
- **åŸå› **: ä¿è¯æ ¸å¿ƒæŒ‡ä»¤å®Œæ•´
- **æ•ˆæœ**: ç‰ºç‰²éƒ¨åˆ†è®°å¿†ä¸Šä¸‹æ–‡

---

## æµ‹è¯•ä¸éªŒè¯

### å•å…ƒæµ‹è¯•

æ¯ä¸ªæ¨¡å—éƒ½åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•ï¼š

1. **memory æ¨¡å—**
   - ç´¢å¼•å’Œæ£€ç´¢æµ‹è¯•
   - è¿‡æœŸæ¸…ç†æµ‹è¯•
   - ç›¸ä¼¼åº¦æœç´¢æµ‹è¯•

2. **sandbox æ¨¡å—**
   - è·¯å¾„éªŒè¯æµ‹è¯•
   - è·¯å¾„ç©¿é€æ£€æµ‹æµ‹è¯•
   - ç¬¦å·é“¾æ¥æ£€æµ‹æµ‹è¯•
   - å®‰å…¨æ–‡ä»¶åæµ‹è¯•

3. **prompt_builder æ¨¡å—**
   - åŸºæœ¬æ„å»ºæµ‹è¯•
   - è®°å¿†ä¸Šä¸‹æ–‡æµ‹è¯•
   - å…ƒæ•°æ®æµ‹è¯•
   - Token æˆªæ–­æµ‹è¯•

### é›†æˆæµ‹è¯•

- æ‰€æœ‰æ¨¡å—åœ¨ lib.rs ä¸­æ­£ç¡®å¯¼å‡º
- ç±»å‹å¼•ç”¨æ­£ç¡®ï¼ˆMemoryEntry, MemoryCategoryï¼‰
- ä¾èµ–æ³¨å…¥æ­£ç¡®ï¼ˆanyhow::Resultï¼‰

### æ–‡æ¡£è¦†ç›–

- æ‰€æœ‰å…¬å…± API éƒ½æœ‰æ–‡æ¡£æ³¨é‡Š
- åŒ…å«ä½¿ç”¨ç¤ºä¾‹
- è¯´æ˜å‚æ•°å’Œè¿”å›å€¼
- æ ‡æ³¨æ³¨æ„äº‹é¡¹

---

## ä½¿ç”¨ç¤ºä¾‹

### è®°å¿†ç³»ç»Ÿä½¿ç”¨

```rust
use agentflow_core::memory::MemoryCore;
use agentflow_core::types::{MemoryEntry, MemoryCategory};
use serde_json::json;

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    // åˆå§‹åŒ–è®°å¿†æ ¸å¿ƒ
    let memory = MemoryCore::new("/path/to/memory.db").await?;

    // åˆ›å»ºè®°å¿†æ¡ç›®
    let entry = MemoryEntry {
        key: "task_123_result".to_string(),
        value: json!("ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"),
        expires_at: None,
        category: MemoryCategory::Result,
        task_id: Some("task_123".to_string()),
        timestamp: chrono::Utc::now().timestamp(),
    };

    // ç´¢å¼•è®°å¿†
    memory.index(&entry).await?;

    // æœç´¢ç›¸å…³è®°å¿†
    let results = memory.search("ä»»åŠ¡æ‰§è¡Œ", 10).await?;

    // è·å–ç»Ÿè®¡ä¿¡æ¯
    let stats = memory.stats().await?;
    println!("æ€»è®°å¿†æ•°: {}", stats.total_entries);

    Ok(())
}
```

### æ²™ç®±ç³»ç»Ÿä½¿ç”¨

```rust
use agentflow_core::sandbox::SandboxConfig;
use std::path::PathBuf;

fn main() -> anyhow::Result<()> {
    // åˆ›å»ºæ²™ç®±é…ç½®
    let mut config = SandboxConfig::new();
    config.add_allowed_dir(PathBuf::from("/workspace"));
    config.add_allowed_dir(PathBuf::from("/tmp/task_work"));

    // éªŒè¯è·¯å¾„
    config.validate_path(Path::new("/workspace/file.txt"))?;

    // åˆ›å»ºå®‰å…¨å­è·¯å¾„
    let safe_path = config.create_safe_path(
        Path::new("/workspace"),
        Path::new("subdir/file.txt")
    )?;

    println!("å®‰å…¨è·¯å¾„: {}", safe_path.display());

    Ok(())
}
```

### Prompt æ„å»ºå™¨ä½¿ç”¨

```rust
use agentflow_core::executor::PromptBuilder;
use agentflow_core::types::{MemoryEntry, MemoryCategory};
use serde_json::json;

fn main() {
    // åˆ›å»ºæ„å»ºå™¨
    let builder = PromptBuilder::new();

    // å‡†å¤‡ä»»åŠ¡å’Œè®°å¿†
    let task = "å®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½";
    let memories = vec![
        MemoryEntry {
            key: "auth_context".to_string(),
            value: json!("ä½¿ç”¨ JWT è¿›è¡Œè®¤è¯"),
            expires_at: None,
            category: MemoryCategory::Context,
            task_id: None,
            timestamp: 0,
        }
    ];

    // æ„å»º Prompt
    let prompt = builder.build(task, &memories);

    println!("ç”Ÿæˆçš„ Prompt:\n{}", prompt);

    // æ£€æŸ¥ token æ•°é‡
    let tokens = builder.estimate_tokens(&prompt);
    println!("ä¼°è®¡ token æ•°: {}", tokens);
}
```

---

## æ€§èƒ½è€ƒè™‘

### è®°å¿†ç³»ç»Ÿ
- **ç´¢å¼•**: O(1) - åŸºäº primary key
- **æœç´¢**: O(n) - éœ€è¦éå†æ‰€æœ‰æ¡ç›®è®¡ç®—ç›¸ä¼¼åº¦
- **ä¼˜åŒ–**: å¯æ·»åŠ å‘é‡ç´¢å¼•ï¼ˆSQLite FTS5ï¼‰æå‡æœç´¢æ€§èƒ½

### æ²™ç®±ç³»ç»Ÿ
- **è·¯å¾„éªŒè¯**: O(p) - p ä¸ºè·¯å¾„æ·±åº¦
- **ç¬¦å·é“¾æ¥æ£€æŸ¥**: O(p Ã— d) - d ä¸ºæœ€å¤§é€’å½’æ·±åº¦
- **ä¼˜åŒ–**: ç¼“å­˜å·²éªŒè¯çš„è·¯å¾„

### Prompt æ„å»ºå™¨
- **æ„å»º**: O(n) - n ä¸ºè®°å¿†æ¡ç›®æ•°
- **æˆªæ–­**: O(m) - m ä¸º prompt é•¿åº¦
- **ä¼˜åŒ–**: é™åˆ¶ max_memory_entries å‡å°‘å¤„ç†æ—¶é—´

---

## æœªæ¥æ”¹è¿›æ–¹å‘

### è®°å¿†ç³»ç»Ÿ
1. é›†æˆä¸“ä¸šåµŒå…¥æ¨¡å‹ï¼ˆOpenAI, HuggingFaceï¼‰
2. æ·»åŠ å‘é‡ç´¢å¼•ï¼ˆSQLite FTS5 æˆ–ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼‰
3. æ”¯æŒå¢é‡ç´¢å¼•å’Œæ‰¹é‡æ“ä½œ
4. æ·»åŠ è®°å¿†å»é‡å’Œåˆå¹¶åŠŸèƒ½

### æ²™ç®±ç³»ç»Ÿ
1. æ·»åŠ æ›´å¤šå®‰å…¨æ£€æŸ¥ï¼ˆæ–‡ä»¶æƒé™ã€ç£ç›˜ç©ºé—´ï¼‰
2. æ”¯æŒç½‘ç»œè®¿é—®ç™½åå•
3. æ·»åŠ å®¡è®¡æ—¥å¿—åŠŸèƒ½
4. æ”¯æŒä¸´æ—¶æ²™ç®±ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰

### Prompt æ„å»ºå™¨
1. æ”¯æŒæ¨¡æ¿ç³»ç»Ÿï¼ˆJinja2 é£æ ¼ï¼‰
2. æ·»åŠ æ›´å¤šé¢„è®¾æ¨¡æ¿
3. æ”¯æŒ prompt ç‰ˆæœ¬ç®¡ç†
4. æ·»åŠ  A/B æµ‹è¯•åŠŸèƒ½

---

## æ€»ç»“

Team B æˆåŠŸå®ç°äº†è®°å¿†ä¸å®‰å…¨æ¨¡å—çš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

### âœ… å®Œæˆçš„åŠŸèƒ½

1. **memory/mod.rs** (467 è¡Œ)
   - SQLite å‘é‡ç´¢å¼•
   - è¯­ä¹‰æ£€ç´¢
   - å®Œæ•´çš„ CRUD æ“ä½œ
   - è¿‡æœŸæ¸…ç†å’Œç»Ÿè®¡

2. **sandbox/mod.rs** (445 è¡Œ)
   - ç›®å½•ç™½åå•æœºåˆ¶
   - è·¯å¾„ç©¿é€é˜²æŠ¤
   - ç¬¦å·é“¾æ¥æ”»å‡»æ£€æµ‹
   - å®‰å…¨æ–‡ä»¶åæ£€æŸ¥

3. **executor/prompt_builder.rs** (490 è¡Œ)
   - æ™ºèƒ½ Prompt æ„å»º
   - Token é•¿åº¦ç®¡ç†
   - å…ƒæ•°æ®æ”¯æŒ
   - è‡ªåŠ¨æˆªæ–­

### ğŸ“Š ä»£ç è´¨é‡

- **æ€»ä»£ç é‡**: 1402 è¡Œ
- **å…¬å…± API**: 45 ä¸ªæ–¹æ³•/å‡½æ•°
- **æµ‹è¯•è¦†ç›–**: æ¯ä¸ªæ¨¡å—éƒ½æœ‰å•å…ƒæµ‹è¯•
- **æ–‡æ¡£**: å®Œæ•´çš„ API æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
- **ä¸­æ–‡æ³¨é‡Š**: æ‰€æœ‰ä»£ç éƒ½æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š

### ğŸ”’ å®‰å…¨ç‰¹æ€§

- âœ“ è·¯å¾„ç©¿é€é˜²æŠ¤
- âœ“ ç¬¦å·é“¾æ¥æ”»å‡»æ£€æµ‹
- âœ“ ç™½åå•è®¿é—®æ§åˆ¶
- âœ“ å®‰å…¨æ–‡ä»¶åéªŒè¯

### ğŸš€ æ€§èƒ½ä¼˜åŒ–

- âœ“ æ•°æ®åº“ç´¢å¼•
- âœ“ è¿æ¥æ± ç®¡ç†
- âœ“ Token é™åˆ¶ç®¡ç†
- âœ“ æ™ºèƒ½æˆªæ–­ç­–ç•¥

æ‰€æœ‰æ¨¡å—éƒ½å·²é›†æˆåˆ° `lib.rs`ï¼Œå¯ä»¥ç«‹å³ä½¿ç”¨ã€‚ä»£ç éµå¾ª Rust æœ€ä½³å®è·µï¼Œç±»å‹å®‰å…¨ï¼Œé”™è¯¯å¤„ç†å®Œå–„ã€‚
