# AgentFlow v0.2.1 - ä»»åŠ¡æ‹†è§£ä¸æ‰§è¡Œè®¡åˆ’

**æ—¥æœŸ**: 2026-01-28
**åˆ†æ”¯**: feature/0.2.0 â†’ feature/0.2.1
**å¹¶è¡Œç­–ç•¥**: 4 ä¸ª Team åŒæ—¶å¼€å‘

---

## ğŸ“‹ æ€»ä½“æ¶æ„ç›®æ ‡

ä»å•ä¸€ Master=Worker æ¶æ„å‡çº§ä¸ºï¼š
- âœ… ç»Ÿä¸€ CLI å…¥å£ (`agentflow`)
- âœ… å¤šæ¨¡å¼è¿è¡Œï¼ˆlocal / cloud / planner-onlyï¼‰
- âœ… Markdown è®°å¿†ä½“ç³»ï¼ˆæ–‡ä»¶=è®°å¿†ï¼‰
- âœ… äº‘ç«¯-è¾¹ç¼˜è”é‚¦æ¶æ„
- âœ… æ™ºè°±æ¸…è¨€ Webhook æ¥å…¥
- âœ… äº¤å‰ç¼–è¯‘å’Œä¸€é”®å®‰è£…

---

## ğŸ¯ Team A: CLI & é…ç½®å±‚

**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜ï¼ˆé˜»å¡å…¶ä»–åŠŸèƒ½ï¼‰

### ä»»åŠ¡åˆ—è¡¨

#### A.1 ç»Ÿä¸€ CLI å…¥å£
- [ ] å¼•å…¥ `clap` ä¾èµ–åˆ° `agentflow-master/Cargo.toml`
- [ ] åˆ›å»º `agentflow-master/src/cli.rs` æ¨¡å—
- [ ] å®ç°å­å‘½ä»¤ç»“æ„ï¼š
  ```rust
  enum Command {
      Server { mode: String },  // local | cloud | planner-only
      Task { action: TaskAction },
      Memory { action: MemoryAction },
      Node { action: NodeAction },
  }
  ```
- [ ] ä¿®æ”¹ `main.rs` ä½¿ç”¨ CLI è§£æè€Œéç›´æ¥å¯åŠ¨æœåŠ¡å™¨
- [ ] å®ç° `agentflow task create/run/list` è°ƒç”¨ç°æœ‰ API

#### A.2 å¤šæ¨¡å¼é…ç½®
- [ ] åˆ›å»º `agentflow-core/src/config/mod.rs`
- [ ] å®ç° `Config` ç»“æ„ä½“ï¼ˆæ”¯æŒ TOML åŠ è½½ï¼‰ï¼š
  ```toml
  [server]
  mode = "local"  # local | cloud | planner-only
  port = 6767

  [cli.worker_safe]
  command = "claude"
  args = ["-p", "--dangerously-skip-permissions"]

  [cli.planner]
  command = "claude"
  args = ["-p", "--model", "claude-3-haiku"]

  [sandbox]
  whitelist_dirs = []
  enable_symlink_protection = true
  ```
- [ ] å®ç°é…ç½®åŠ è½½é€»è¾‘ï¼ˆ`~/.agentflow/config.toml` æˆ– `./agentflow.toml`ï¼‰
- [ ] æ ¹æ®æ¨¡å¼å¯åŠ¨ä¸åŒæ¨¡å—

#### A.3 é¢„ç•™ API ç«¯ç‚¹
- [ ] æ·»åŠ  `/api/v1/nodes` (GET) - åˆ—å‡ºèŠ‚ç‚¹ï¼ˆmockï¼‰
- [ ] æ·»åŠ  `/api/v1/cluster/status` (GET) - é›†ç¾¤çŠ¶æ€ï¼ˆmockï¼‰
- [ ] æ·»åŠ  `/api/v1/config` (GET) - å½“å‰é…ç½®

**äº¤ä»˜ç‰©**:
- `rust/agentflow-master/src/cli.rs`
- `rust/agentflow-core/src/config/mod.rs`
- `agentflow.toml.example` é…ç½®ç¤ºä¾‹

---

## ğŸ§  Team B: è®°å¿†ä½“ç³» & Git é›†æˆ

**ä¼˜å…ˆçº§**: ğŸŸ¡ é«˜ï¼ˆæ ¸å¿ƒé—­ç¯ï¼‰

### ä»»åŠ¡åˆ—è¡¨

#### B.1 Markdown Chunker
- [ ] åˆ›å»º `agentflow-core/src/memory/chunker.rs`
- [ ] å®ç° `Chunker::chunk_markdown()` æŒ‰æ ‡é¢˜/æ®µè½åˆ‡åˆ†
- [ ] ä¿æŒä¸Šä¸‹æ–‡ï¼ˆå‰ä¸€æ®µ token å°¾éƒ¨ï¼‰
- [ ] ç”Ÿæˆå¸¦å…ƒæ•°æ®çš„ chunkï¼š
  ```rust
  struct Chunk {
      id: String,
      source_file: PathBuf,
      index: usize,
      content: String,
      metadata: HashMap<String, String>,
  }
  ```

#### B.2 Embedder Trait
- [ ] åˆ›å»º `agentflow-core/src/memory/embedder.rs`
- [ ] å®šä¹‰ `Embedder` traitï¼š
  ```rust
  trait Embedder {
      async fn embed(&self, text: &str) -> Result<Vec<f32>>;
  }
  ```
- [ ] å®ç° `ClaudeCliEmbedder`ï¼ˆè°ƒç”¨ claude ç”Ÿæˆ embeddingï¼‰
- [ ] é¢„ç•™ `GLM4Embedder` å ä½ï¼ˆæœªæ¥ HTTP è°ƒç”¨ï¼‰

#### B.3 æ–‡ä»¶ç›‘å¬ä¸ç´¢å¼•
- [ ] åˆ›å»º `agentflow-core/src/memory/indexer.rs`
- [ ] ä½¿ç”¨ `notify` crate ç›‘å¬ `.agentflow/memory/` ç›®å½•
- [ ] å®ç° `Indexer::reindex_file()`ï¼š
  - æ¸…é™¤æ—§ chunk
  - é‡æ–° chunk + embed
  - æ’å…¥ SQLite
- [ ] æ•°æ®åº“ migrationï¼š
  ```sql
  CREATE TABLE memory_chunks (
      id TEXT PRIMARY KEY,
      source_file TEXT,
      chunk_index INTEGER,
      content TEXT,
      embedding BLOB,
      metadata TEXT,
      updated_at DATETIME
  );

  CREATE VIRTUAL TABLE memory_fts USING fts5(content);
  ```

#### B.4 æ‰§è¡Œåè‡ªåŠ¨å›å†™
- [ ] ä¿®æ”¹ `TaskExecutor::execute()` åç½®å¤„ç†
- [ ] æ£€æµ‹ Git diff / stderr / `<save_memory>` æ ‡è®°
- [ ] å›å†™åˆ° `memory/{date}.md`ï¼š
  ```markdown
  ## 2026-01-28 Task Summary

  **Commit**: abc123

  ### Changes
  - Added feature X
  - Fixed bug Y

  ### Errors Encountered
  - Error Z: Solution...
  ```
- [ ] è§¦å‘ `Indexer::reindex_file()`

#### B.5 Prompt æ³¨å…¥
- [ ] ä¿®æ”¹ `PromptBuilder` åœ¨æ„å»ºæ—¶è°ƒç”¨ `MemoryCore::search()`
- [ ] æ³¨å…¥ Top 3 ç›¸å…³è®°å¿†åˆ° System Prompt
- [ ] æ ¼å¼ï¼š
  ```
  System: You are AgentFlow...

  Relevant Memory:
  1. [2026-01-27] Fixed similar bug...
  2. [2026-01-26] Implemented feature X...
  3. ...

  User Task: ...
  ```

**äº¤ä»˜ç‰©**:
- `rust/agentflow-core/src/memory/{chunker,embedder,indexer}.rs`
- æ•°æ®åº“ migration æ–‡ä»¶
- `.agentflow/memory/` ç›®å½•ç»“æ„

---

## â˜ï¸ Team C: äº‘ç«¯ / è¾¹ç¼˜è”é‚¦

**ä¼˜å…ˆçº§**: ğŸŸ¡ é«˜ï¼ˆåˆ†å¸ƒå¼èƒ½åŠ›ï¼‰

### ä»»åŠ¡åˆ—è¡¨

#### C.1 èŠ‚ç‚¹æ³¨å†Œä¸èº«ä»½
- [ ] åˆ›å»º `agentflow-core/src/node/mod.rs`
- [ ] å®ç° `Node` ç»“æ„ä½“ï¼š
  ```rust
  struct Node {
      id: String,
      fingerprint: String,  // md5(pubkey)
      endpoint: String,
      last_heartbeat: DateTime<Utc>,
      labels: HashMap<String, String>,
  }
  ```
- [ ] å®ç° `NodeRegistry`ï¼š
  - `register(node_info) -> Result<()>`
  - `heartbeat(node_id) -> Result<()>`
  - `determine_target(task_plan) -> Option<NodeId>`
- [ ] æ•°æ®åº“è¡¨ï¼š
  ```sql
  CREATE TABLE nodes (
      id TEXT PRIMARY KEY,
      fingerprint TEXT UNIQUE,
      endpoint TEXT,
      last_heartbeat INTEGER,
      labels TEXT,
      status TEXT  -- active | inactive
  );

  CREATE TABLE trusted_nodes (
      fingerprint TEXT PRIMARY KEY,
      added_at INTEGER
  );
  ```

#### C.2 Hello/Heartbeat åè®®
- [ ] Edge Node å¯åŠ¨æ—¶å‘é€ `Hello{node_id,fingerprint}`
- [ ] Cloud Master éªŒè¯ fingerprint æ˜¯å¦åœ¨ `trusted_nodes`
- [ ] å®ç° WebSocket å¿ƒè·³ï¼ˆæ¯ 30 ç§’ï¼‰
- [ ] è¶…æ—¶è‡ªåŠ¨æ ‡è®°ä¸º inactive

#### C.3 Webhook å…¥å£
- [ ] å®ç° `/api/v1/webhook/zhipu` (POST)
- [ ] è¯·æ±‚ Bodyï¼š
  ```json
  {
    "text": "åœ¨ DiveAdstra ä¸Šè·‘ä¸€æ¬¡ DX12 æ€§èƒ½æµ‹è¯•"
  }
  ```
- [ ] å¤„ç†æµç¨‹ï¼š
  1. éªŒè¯ `Authorization: Bearer <secret>`
  2. è°ƒç”¨ `cli.planner` æ‰§è¡Œæ„å›¾è¯†åˆ« + ä»»åŠ¡æ‹†åˆ†
  3. ä½¿ç”¨ `NodeRegistry::determine_target` é€‰æ‹©èŠ‚ç‚¹
  4. å°†ä»»åŠ¡æ¨é€åˆ°ç›®æ ‡èŠ‚ç‚¹ `/api/v1/tasks`
  5. è¿”å›ç»“æœï¼š
     ```json
     {
       "status": "dispatched",
       "task_id": 123,
       "target_node": "home_win",
       "message": "å·²ä¸‹å‘è‡³ Windows èŠ‚ç‚¹æ‰§è¡Œ"
     }
     ```

#### C.4 å®‰å…¨ä¸é‰´æƒ
- [ ] é…ç½®é¡¹ï¼š
  ```toml
  [webhook]
  secret = "your-secret-here"
  rate_limit_per_ip = 10
  allowed_actions = ["run_test", "benchmark", "status"]
  ```
- [ ] å®ç°é™æµä¸­é—´ä»¶ï¼ˆåŸºäº IPï¼‰
- [ ] é«˜å±æ“ä½œæ£€æµ‹ï¼ˆ`install`, `system` å…³é”®å­—ï¼‰
- [ ] Edge Node è¿æ¥æ—¶è®°å½•æ—¥å¿—æç¤ºæ·»åŠ æŒ‡çº¹

**äº¤ä»˜ç‰©**:
- `rust/agentflow-core/src/node/mod.rs`
- `rust/agentflow-master/src/routes/webhook.rs`
- `/api/v1/webhook/zhipu` ç«¯ç‚¹
- Hello/Heartbeat WebSocket å®ç°

---

## ğŸ“¦ Team D: å·¥ç¨‹æ‰“ç£¨

**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­ï¼ˆç”¨æˆ·ä½“éªŒï¼‰

### ä»»åŠ¡åˆ—è¡¨

#### D.1 äº¤å‰ç¼–è¯‘é…ç½®
- [ ] åˆ›å»º `.github/workflows/release.yml`
- [ ] é…ç½®è§¦å‘æ¡ä»¶ï¼šTag push (`v*`)
- [ ] æ„å»ºç›®æ ‡ï¼š
  - `linux-amd64`
  - `linux-arm64`
  - `darwin-amd64`
  - `darwin-arm64`
  - `windows-amd64`
- [ ] ä¸Šä¼ åˆ° GitHub Release
- [ ] ï¼ˆå¯é€‰ï¼‰ä¸Šä¼ åˆ° `bin/` ç›®å½•

#### D.2 ä¸€é”®å®‰è£…è„šæœ¬
- [ ] åˆ›å»º `scripts/install.sh` (Linux/macOS)ï¼š
  ```bash
  #!/bin/bash
  # 1. æ£€æµ‹ OS å’Œæ¶æ„
  # 2. ä¸‹è½½å¯¹åº”äºŒè¿›åˆ¶
  # 3. å®‰è£…åˆ° /usr/local/bin æˆ– ~/.local/bin
  # 4. ç”Ÿæˆ ~/.agentflow/config.toml
  # 5. è¿è¡Œ agentflow info è‡ªæ£€
  ```
- [ ] åˆ›å»º `scripts/install.ps1` (Windows)
- [ ] æ·»åŠ æ‰§è¡Œæƒé™ï¼š`chmod +x scripts/install.sh`

#### D.3 æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–° `README.md`ï¼š
  - å¢åŠ  "äº‘ç«¯ / è¾¹ç¼˜ æ¨¡å¼ä½¿ç”¨ç¤ºä¾‹"
  - å¢åŠ  "æ™ºè°±æ¸…è¨€æ™ºèƒ½ä½“æ¥å…¥ç¤ºä¾‹"
  - æ›´æ–°å®‰è£…è¯´æ˜
- [ ] åˆ›å»º `docs/ZHIPU_INTEGRATION.md`ï¼š
  - æ™ºè°±æ¸…è¨€ Webhook é…ç½®
  - Body ç¤ºä¾‹
  - å®‰å…¨é…ç½®å»ºè®®
  - æ•…éšœæ’æŸ¥
- [ ] åˆ›å»º `docs/CONFIGURATION.md`ï¼š
  - `agentflow.toml` å®Œæ•´é…ç½®è¯´æ˜
  - å„æ¨¡å¼å·®å¼‚å¯¹æ¯”

#### D.4 æµ‹è¯•ä¸éªŒè¯
- [ ] åœ¨ macOS ä¸Šæµ‹è¯• `install.sh`
- [ ] åœ¨ Linux ä¸Šæµ‹è¯• `install.sh`
- [ ] åœ¨ Windows ä¸Šæµ‹è¯• `install.ps1`
- [ ] éªŒè¯å„æ¨¡å¼å¯åŠ¨ï¼š
  - `agentflow server local`
  - `agentflow server cloud`
  - `agentflow server planner-only`

**äº¤ä»˜ç‰©**:
- `.github/workflows/release.yml`
- `scripts/install.sh`
- `scripts/install.ps1`
- `docs/ZHIPU_INTEGRATION.md`
- `docs/CONFIGURATION.md`
- æ›´æ–°çš„ `README.md`

---

## ğŸš€ å¹¶è¡Œæ‰§è¡Œç­–ç•¥

### æ—¶é—´çº¿ï¼ˆå»ºè®® 2-3 å‘¨ï¼‰

**Week 1: åŸºç¡€è®¾æ–½**
- Team A: CLI & Configï¼ˆé˜»å¡å…¶ä»–ï¼‰
- Team D: äº¤å‰ç¼–è¯‘é…ç½®ï¼ˆç‹¬ç«‹ï¼‰
- Team B/C: ç­‰å¾… Team A å®Œæˆ config

**Week 2: æ ¸å¿ƒåŠŸèƒ½**
- Team B: Memory & Git é›†æˆ
- Team C: Cloud/Edge è”é‚¦
- Team D: å®‰è£…è„šæœ¬å’Œæ–‡æ¡£

**Week 3: é›†æˆä¸æµ‹è¯•**
- å…¨å‘˜ï¼šé›†æˆæµ‹è¯•
- Team D: æœ€ç»ˆæ‰“ç£¨å’Œå‘å¸ƒ

### ä¾èµ–å…³ç³»

```
Team A (Config) â”€â”¬â”€> Team B (Memory)
                 â””â”€> Team C (Cloud/Edge)

Team D (Packaging) â”€â”€> ç‹¬ç«‹ï¼Œå¯å¹¶è¡Œ
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] `agentflow server local` å¯åŠ¨æœ¬åœ°æ¨¡å¼
- [ ] `agentflow server cloud` å¯åŠ¨äº‘ç«¯æ¨¡å¼
- [ ] `agentflow task create "test"` åˆ›å»ºä»»åŠ¡
- [ ] Markdown æ–‡ä»¶è‡ªåŠ¨ç´¢å¼•åˆ° SQLite
- [ ] ä»»åŠ¡æ‰§è¡Œåè‡ªåŠ¨å›å†™ `memory/{date}.md`
- [ ] Edge Node æˆåŠŸæ³¨å†Œåˆ° Cloud Master
- [ ] æ™ºè°±æ¸…è¨€ Webhook æˆåŠŸä¸‹å‘ä»»åŠ¡

### æ€§èƒ½éªŒæ”¶
- [ ] å†…å­˜å ç”¨ < 150MBï¼ˆç©ºé—²ï¼‰
- [ ] CLI å“åº” < 100ms
- [ ] Webhook å“åº” < 500ms
- [ ] èŠ‚ç‚¹å¿ƒè·³ 30 ç§’è¶…æ—¶æ£€æµ‹

### å®‰å…¨éªŒæ”¶
- [ ] æœªæˆæƒ Edge Node è¿æ¥è¢«æ‹’ç»
- [ ] Webhook æ—  Bearer token è¿”å› 401
- [ ] é™æµç”Ÿæ•ˆï¼ˆ> 10 æ¬¡/åˆ†é’Ÿè¿”å› 429ï¼‰
- [ ] é«˜å±æ“ä½œè¢« planner æ‹’ç»

---

## ğŸ‰ æœ€ç»ˆç›®æ ‡

å®Œæˆ v0.2.1 åï¼ŒAgentFlow å°†æˆä¸ºï¼š

1. **æ˜“ç”¨**: `agentflow` å•ä¸€å‘½ä»¤ï¼Œå¤šæ¨¡å¼åˆ‡æ¢
2. **æ™ºèƒ½**: Markdown è®°å¿†ä½“ç³»ï¼Œè‡ªåŠ¨ç´¢å¼•å’Œæ£€ç´¢
3. **åˆ†å¸ƒå¼**: äº‘ç«¯-è¾¹ç¼˜è”é‚¦ï¼Œæ‰‹æœºè¿œç¨‹æŒ‡æŒ¥
4. **ç”Ÿäº§å°±ç»ª**: ä¸€é”®å®‰è£…ï¼Œå®Œæ•´æ–‡æ¡£ï¼Œäº¤å‰ç¼–è¯‘

**ä¸ªäººåŸºç¡€è®¾æ–½çš„å®Œæ•´å½¢æ€ï¼** ğŸš€
