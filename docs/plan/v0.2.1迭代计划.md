一、CLI & 配置层：统一入口，多模式配置（优先级最高）
目标：从现在的“手动 ./target/release/agentflow-master”提升到统一的命令行体验，并显式支持不同运行模式（local / cloud / planner-only）。
1. 统一 CLI 入口 agentflow
- 入口：一个 `agentflow` 命令，替代直接调用 `agentflow-master`。
- 子命令建议：
  - `agentflow server [mode]`：启动服务器（mode = local | cloud | planner-only）
  - `agentflow task create <title> [desc]`：创建任务（调用 POST /api/v1/tasks）
  - `agentflow task run <id>`：执行并流式输出（对齐 SSE / WebSocket）
  - `agentflow task list`：列出任务
  - `agentflow memory search <query>`：调用记忆检索
  - `agentflow node list / status`：列出已注册边缘节点 / 状态
- 实现位置：
  - 在 `rust/agentflow-master/src/main.rs` 里引入 `clap` 或类似的 CLI 解析库。
  - 把现有启动逻辑收敛为 `server` 子命令的默认实现。
1. 多模式配置（local / cloud / planner-only）
- 配置文件：`agentflow.toml`（可以约定放在项目根或 `~/.agentflow/config.toml`）。
- 模式说明：
  - `mode = "local"`：本地 Master=Worker，直接跑 Claude CLI；这是你现在的默认行为。
  - `mode = "cloud"`：
    - 启用节点注册 / 心跳 / 任务路由相关模块。
    - Webhook 接收来自智谱清言的请求（后续阶段）。
    - 也可以作为“云端 planner”，调用本地 CLI 做任务规划（不直接改文件）。
  - `mode = "planner-only"`：
    - 只运行“理解+规划”，不接本地 CLI Worker，适用于纯转发或你手动在别处执行的场景。
- 示例配置结构（简化版）：
  ```toml
  [server]
  mode = "local"   # local | cloud | planner-only
  port = 6767
  host = "0.0.0.0"
  [cli]
  # local 模式下使用
  [cli.worker_safe]
  command = "claude"
  args = ["-p", "--dangerously-skip-permissions", "--allowedTools", "Read,Edit,Bash(git *)"]
  # cloud/planner 模式下的轻量 planner 配置
  [cli.planner]
  command = "claude"
  args = ["-p", "--model", "claude-3-haiku"]
  [sandbox]
  whitelist_dirs = ["/home/me/repos", "/Users/me/repos"]
  enable_symlink_protection = true
  max_task_seconds = 1800
  ```
- 实现任务：
  - 新增 `rust/agentflow-core/src/config.rs`（如果还没有独立配置模块），用 `serde` + `toml` 加载配置。
  - 在 `main.rs` 中根据 `mode` 决定启动哪些模块（路由、节点注册器、Webhook 等）。
  - 为云模式预留 `/api/v1/nodes`、`/api/v1/cluster/status` 等端点占位（可以先只返回 mock，下一阶段填充）。
二、记忆体系 & Git 集成：把“文件=记忆”做成闭环（与之前 ClawDBot 风格对齐）
你已经有了 SQLite + 向量索引的 MemoryCore 基础，这一步主要做两件事：
- 把 Markdown 文件 → chunk → embedding → SQLite FTS5+向量 全链路打通；
- 把任务执行后的产出（diff / commit / 错误日志）自动写回 Markdown，并触发索引更新。
1. Markdown → chunk → embedding → 索引
- 在 `rust/agentflow-core/src/memory/` 下新增/补全模块：
  - `chunker.rs`：Markdown 按标题/段落切分，并保持每块带上上下文（例如前一段尾巴 token）。
  - `embedder.rs`：定义 `Embedder` trait（现在可以是 CLI，也可以是未来 HTTP 调用），默认实现直接调用 `claude` 做嵌入，或者预留接入 GLM-4-Embeddings。
  - `indexer.rs`：监听 `.agentflow/memory/` 下 `.md` 文件变更（用 `notify` crate），变更触发：
    - 清除该文件旧 chunk；
    - 重新 chunk + embed；
    - 插入 SQLite，并同步到 FTS5 虚拟表。
- 数据库表（如果还没有，补充 migration）：
  - `memory_chunks(id, source_file, chunk_index, content, embedding, metadata, updated_at)`
  - `memory_fts`（FTS5 虚拟表，通过 trigger 同步 `content` 字段）
1. 执行后自动回写记忆
- 在 `TaskExecutor` 执行完任务后，检查：
  - Git diff 是否非空；
  - stderr 中是否包含明显错误模式；
  - Claude 的 stdout 里是否有约定标记（例如 `<save_memory>`）。
- 回写策略：
  - 将 commit 摘要 + 关键 diff 片段写入 `memory/{date}.md`，格式简单 Markdown，方便人工编辑。
  - 立即触发 `Indexer::reindex_file`。
- 额外 Prompt 注入：
  - 在后续相关任务中，通过 `MemoryCore::search(task_description)` 取出 Top 3 条，注入 System Prompt，形成长记忆闭环。
三、云端 / 边缘联邦：节点注册与路由（为“云-边”打基础）
你现在的 README 里已经有单进程 Master=Worker 的架构，接下来把它升级为“多节点联邦”，但依然保持每个节点都是 Master=Worker。
1. 节点注册与身份
- 引入 `Node` 概念：
  - 每个节点有 `node_id`（可以默认为主机名 + 端口，或配置指定）。
  - 公钥指纹 `fingerprint = md5(pubkey)` 作为节点唯一标识，用于鉴权。
- 新增模块 `rust/agentflow-core/src/node/registry.rs`：
  - `NodeRegistry` 维护：
    - `local_mode`: 只允许本节点。
    - `cloud_mode`: 记录连接的 Edge Node（id, endpoint, last_heartbeat, labels 等）。
  - 提供：
    - `register(node_info)`
    - `heartbeat(node_id)`
    - `determine_target(task_plan) -> Option<NodeId>`
1. 云端 Master 上的 Webhook / 路由入口
- 在云模式下，启用 `/api/v1/webhook/zhipu`（先按简单 JSON body 设计）：
  ```json
  {
    "text": "在 DiveAdstra 上跑一次 DX12 性能测试"
  }
  ```
- 处理流程：
  - 调用 `cli.planner` 执行一次“意图识别 + 任务拆分”，返回结构化 JSON（如 `target_node_id`, `repo_path`, `steps[]`）。
  - 使用 `NodeRegistry::determine_target` 选一个合适节点（默认按 repo 绑定）。
  - 将任务推送到该节点的 `/api/v1/tasks` 接口（可以使用现有 API，新增一个字段 `from_node_id` 表示来源）。
1. 安全与鉴权
- Edge Node 首次连接到 Cloud Master 时发送 `Hello{node_id,fingerprint}`。
- Cloud Master 检查本地 `trusted_nodes` 表（SQLite）：
  - 若 fingerprint 已在白名单 → 允许；
  - 否则 → 拒绝，并在日志中提示“请在云端添加该指纹”。
- Webhook 入口增加：
  - Header `Authorization: Bearer <webhook_secret>` 校验；
  - 基于内存或 Redis 的简单限流（IP / 分钟），避免刷量。
四、外部接入层：智谱清言 Webhook + 安全策略（让手机变成“遥控器”）
这步完全建立在“云端 Master + CLI planner”基础之上，不增加复杂度，只是暴露一个 Webhook 入口。
1. Webhook 设计（最小可用版）
- URL：`/api/v1/webhook/zhipu`
- Body：
  ```json
  { "text": "DiveAdstra 上跑 DX12 性能测试" }
  ```
- 返回（简单文本）：
  ```json
  {
    "status": "dispatched",
    "task_id": 123,
    "target_node": "home_win",
    "message": "已下发至 Windows 节点执行，预计 15 分钟出结果"
  }
  ```
- 内部逻辑：
  - 调用 `cli.planner` 返回 JSON 计划；
  - 将计划转为内部 Task 插入 SQLite；
  - 分发给目标 Edge Node；
  - 将结果文本返回给智谱清言 App。
1. 安全加固
- 配置项：
  - `[webhook] secret = "..."`（Bearer token）。
  - `[webhook] rate_limit_per_ip = 10`（每分钟限制）。
  - `[webhook] allowed_actions = ["run_test","benchmark","status"]`（只允许特定类型任务）。
- 对于 “可能高危” 的 action（比如包含 `install`、`system` 关键字），planner 直接拒绝，或者只返回一个“建议命令列表”，不自动执行。
五、工程打磨：打包、安装脚本、文档（让项目对他人也“开箱即用”）
你已经有 `rust/agentflow-core` + `agentflow-master` 结构，下一步补齐“交付物”：
1. 交叉编译与二进制发布
- 在 `.github/workflows/release.yml` 中添加：
  - Tag push 时自动构建 `linux-amd64`、`linux-arm64`、`darwin-amd64`、`darwin-arm64`、`windows-amd64`。
  - 上传到 `bin/` 目录或 GitHub Release。
1. 一键安装脚本
- `scripts/install.sh`（Linux/macOS）：
  - 自动检测 OS 与架构；
  - 下载对应 `agentflow` 二进制到 `/usr/local/bin` 或 `~/.local/bin`；
  - 生成默认 `~/.agentflow/config.toml`；
  - 运行 `agentflow info` 做自检。
- `scripts/install.ps1`（Windows）同理。
1. 文档补齐
- README：
  - 增加 “云端 / 边缘 模式使用示例”；
  - 增加 “智谱清言智能体接入示例”。
- 新增 `docs/ZHIPU_INTEGRATION.md`：
  - 如何在智谱清言里配置 Webhook；
  - Body 示例与返回示例；
  - 安全配置建议。
六、并行开发拆分建议（可直接丢给 Agent）
- Team A：CLI & Config
  - 统一 `agentflow` 命令；
  - `config.rs` 与 `agentflow.toml` 支持 local/cloud/planner-only 模式；
  - 新增基础 `node` 相关端点（可以先返回 mock）。
- Team B：Memory & Git Integration
  - 实现 `chunker.rs`、`embedder.rs`（基于现有 MemoryCore 做补全）；
  - 实现 `indexer.rs` 文件监听 + 自动 reindex；
  - 在 TaskExecutor 后置 hook 里实现自动回写 Markdown。
- Team C：Cloud / Edge & Webhook
  - `NodeRegistry` 和 Hello/Heartbeat 协议；
  - `/api/v1/webhook/zhipu` 实现 + 调用 `cli.planner`；
  - 简单的限流与鉴权中间件。
- Team D：Packaging & Docs
  - GitHub Actions 交叉编译配置；
  - `install.sh` / `install.ps1`；
  - 更新 README + 新增 `ZHIPU_INTEGRATION.md`。
这样迭代下来，你会得到：
- 对外：一个安装即用、单二进制的 AgentFlow；
- 对内：一个有长记忆、有云端-边缘协同、能通过智谱清言/手机远程指挥的完整“个人基础设施”。