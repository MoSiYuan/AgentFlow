```markdown
# AgentFlow 开发任务：Skill 引导强化系统
## 1. 背景与目标
**问题**：默认的 Claude CLI 倾向于做一个“谨慎的客服”，它倾向于提问、寻求许可、生成代码片段而不是直接执行。这不适合 AgentFlow 这种“全自动 DevOps”的场景。
**目标**：构建一个 **“动态 Prompt 引导系统”**，通过 System Prompt 覆盖、项目级配置注入、历史记忆回溯，强制 Agent 变成一位**“不废话、猛冲猛打、懂项目规则的高级工程师”**。
---
## 2. 核心架构：四级 Prompt 构造器
在 Rust 侧实现一个 `PromptBuilder` 模块。每次执行任务时，不是简单地传递用户指令，而是按以下顺序动态组装一个巨大的 System Prompt：
1.  **Level 1 [Hardcoded]**：核心身份与行为准则（覆盖 Claude 默认的“安全限制”）。
2.  **Level 2 [Project]**：项目专属技能集（读取 `AGENTFLOW.md`）。
3.  **Level 3 [Memory]**：相关历史经验（从 SQLite MemoryCore 检索）。
4.  **Level 4 [Context]**：运行时上下文（Git 状态、当前目录）。
5.  **Level 5 [Task]**：用户的具体指令。
---
## 3. 实施任务清单
### Phase 1: 实现 PromptBuilder 引擎
**文件**：`rust/agentflow-core/src/llm/prompt_builder.rs` (新建)
**逻辑要求**：
1.  定义结构体 `PromptBuilder`，包含 `workspace_path` 和 `MemoryCore` 引用。
2.  实现 `build(task: &str) -> Result<String>` 方法：
    - 读取 `{workspace_path}/AGENTFLOW.md`。如果存在，提取内容。
    - 调用 `MemoryCore::search(task, top_k=3)` 获取历史记忆。
    - 获取当前 Git 状态（简略版）。
    - 按上述 Level 1-5 顺序拼接字符串。
3.  将此 Builder 集成到 `TaskExecutor` 中，替换现有的简单 prompt 传递逻辑。
**代码结构示意**：
```rust
pub struct PromptBuilder {
    base_identity: &'static str,
    workspace: PathBuf,
    memory: Arc<MemoryCore>,
}
impl PromptBuilder {
    pub async fn build(&self, user_task: &str) -> Result<String> {
        // 拼接五层 Prompt
    }
}
```
### Phase 2: 定义强 System Prompt (Level 1)
**文件**：`rust/agentflow-core/src/llm/prompts.rs` (新建)
**任务**：编写 `const BASE_SYSTEM_PROMPT: &str`。
**内容要求（必须包含）**：
- **Role**: 声明自己是 "AgentFlow Execution Engine"，而非 Chat Assistant。
- **Directives**:
    - **Action First**: 不说 "I suggest"，直接 "I will..."。
    - **Tool Usage**: 明确优先使用 `Bash` 执行构建/测试/命令，而非生成代码块。
    - **Git Mandatory**: 任何实质性代码修改后，必须执行 `git add && git commit`。
    - **Self-Healing**: 命令报错时，尝试分析并修复，不要直接停止。
- **Protocol**: 引入简单的 CoT（思维链），要求 Agent 在行动前先思考步骤，但不输出思考过程。
### Phase 3: 设计项目级配置 `AGENTFLOW.md` (Level 2)
**任务**：制定 `AGENTFLOW.md` 的标准格式，并在 AgentFlow 仓库中创建一个示例文件。
**文件**：`templates/AGENTFLOW.md.example`
**内容结构要求**：
```markdown
# Project Skills
## 1. Build System
- Windows: `msbuild ...`
- Linux: `make ...`
## 2. Testing Workflow
- 不要运行 `make test`。
- 运行测试的正确命令：`./bin/test --suite=unit`
## 3. Critical Skills (Do's and Don'ts)
- DO: 提交前必须跑 `linter`。
- DON'T: 不要修改 `third_party/` 目录下的文件。
- SKILL: 遇到 Shader 报错，需要删除 `Cache/` 目录。
## 4. Debugging Strategy
- 崩溃时优先检查 `Logs/`。
```
**逻辑**：
- Rust 的 `PromptBuilder` 必须检测该文件。如果不存在，注入默认提示；如果存在，全文注入。
### Phase 4: 历史记忆引导 (Level 3)
**任务**：利用现有的 `MemoryCore`，实现“经验复用”。
**逻辑要求**：
- 当用户下达指令时（如“优化渲染性能”）。
- `PromptBuilder` 调用检索。
- 将检索结果格式化为 "Few-Shot Examples" 注入 Prompt：
  ```markdown
  ## Relevant Historical Experience
  [2025-01-10] 优化渲染管线：合并了 Draw Call，提升了 20% FPS。关键文件：RenderPass.cpp。
  请参考以上经验处理当前任务。
  ```
---
## 4. 验收标准
完成开发后，进行以下测试，确保 Skill 引导生效：
### Test Case 1: 强制执行
- **输入**: "跑个测试"
- **Bad Output**: "好的，我可以帮你运行测试，你想运行哪一个？..."
- **Expected Output**: (直接执行 Bash) `./bin/run-tests ...` -> "测试完成，正在提交代码。"
### Test Case 2: 遵循项目规则
- 在 `DiveAdstra` 仓库中配置 `AGENTFLOW.md`，写入 "Build 命令是 `msbuild`"。
- **输入**: "编译一下"
- **Expected Output**: Agent 必须调用 `msbuild`，而不是 `make` 或 `gcc`。
### Test Case 3: 基于经验
- 历史记录中有："解决崩溃需删除 Shader Cache"。
- **输入**: "游戏崩溃了，修一下"
- **Expected Output**: Agent 应该主动尝试 `rm -rf Cache/` 或类似操作，表现出“以前遇到过这个问题”的智能。
---
## 5. 开发优先级
1.  **High**: Phase 1 (PromptBuilder) & Phase 2 (Base Prompt)。这是最基础的底座。
2.  **High**: Phase 3 (`AGENTFLOW.md`)。这是让 AgentFlow 适配不同项目的关键。
3.  **Medium**: Phase 4 (Memory Injection)。锦上添花，需要记忆模块配合。
请按照以上任务列表开始编码。
```
