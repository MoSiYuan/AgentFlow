# v0.2.3 需求分析与决策总结

**日期**: 2026-01-28
**状态**: 需求分析完成，迭代计划已制定

---

## 📊 原始需求 vs 实施计划

### 原始需求（docs/plan/v0.2.3.md）

4 个核心 Issue：
1. **Issue #1**: Feature Branch 工作流
2. **Issue #2**: DAG 任务调度器
3. **Issue #3**: 动态技能清单
4. **Issue #4**: Tree-sitter 索引

---

## ✅ 合理性分析结果

### 高价值功能（立即实现）

#### 1. Feature Branch 工作流 ✅

**价值**: 🔴 极高
**成本**: 🟢 低
**契合度**: 100%

**理由**:
- 保护 `main` 分支不被破坏
- 符合 Git 最佳实践
- 与 v0.2.1 "Git Mandatory" 原则完美契合
- 实现简单，风险低

**决策**: **✅ 立即实现（Phase 1）**

---

#### 2. DAG 任务调度器 ✅

**价值**: 🔴 极高
**成本**: 🟡 中等
**契合度**: 100%

**理由**:
- 分布式执行的核心机制
- v0.2.1 Team C 已规划云端联邦
- 依赖管理是自动化的基础
- 多节点协作必需

**决策**: **✅ 立即实现（Phase 2）**

---

### 中等价值功能（按需实现）

#### 3. 动态技能清单 ⚠️

**价值**: 🟡 中等
**成本**: 🟢 低
**契合度**: 80%

**理由**:
- 标准化命令，避免 LLM "发明"命令
- 与 AGENTFLOW.md 功能重叠
- 可以增强现有 AGENTFLOW.md
- 不是必需的，但有价值

**决策**: **✅ 作为增强功能实现（Phase 3）**

**调整**:
- 不使用独立的 `skills.json`
- 将技能定义直接整合到 `AGENTFLOW.md`
- 减少配置文件复杂度

---

### 低优先级功能（延后实现）

#### 4. Tree-sitter 索引 ❌

**价值**: 🟢 低
**成本**: 🔴 高
**契合度**: 30%

**理由**:
- 性能优化，非功能需求
- Tree-sitter 集成复杂
- 中小型项目不需要
- 维护成本高（跟随语言语法更新）

**决策**: **❌ 延后到 v0.3.x**

**触发条件**:
- 项目代码 > 10 万行
- CLI 执行时间 > 30 秒
- Token 成本显著上升

---

## 🎯 核心调整

### 调整 1: 简化技能清单

**原方案**: 独立的 `skills.json`
**新方案**: 整合到 `AGENTFLOW.md`

**理由**:
- 减少配置文件数量
- 统一项目配置入口
- 降低用户学习成本

**新格式**:
```markdown
# AGENTFLOW.md

## 技能定义

### compile
- **描述**: 编译项目
- **命令**: `msbuild {project}.sln /p:Configuration={config}`
- **参数**:
  - `project`: 项目名称（默认: AgentFlow）
  - `config`: Debug 或 Release（默认: Release）

### test
- **描述**: 运行测试
- **命令**: `cargo test --package {package}`
- **参数**:
  - `package`: 包名（必需）
```

---

## 📅 实施计划

### 三阶段迭代

| 阶段 | 时间 | 功能 | 优先级 |
|------|------|------|--------|
| **Phase 1** | Days 1-3 | Git 工作流自动化 | 🔴 P0 |
| **Phase 2** | Days 4-10 | DAG 任务调度器 | 🔴 P0 |
| **Phase 3** | Days 11-12 | 动态技能清单增强 | 🟡 P1 |

**总计**: 12 天（2 周）

---

## 🔄 与现有架构的关系

### v0.2.1 基础（已完成）

```
Skill 引导系统:
├── Level 1: 强系统提示词
├── Level 2: AGENTFLOW.md
├── Level 3: 自动记忆检索
└── Level 4: 用户指令
```

### v0.2.3 增强（待实施）

```
工作流自动化:
├── Git 工作流（保护 main 分支）
├── DAG 调度（分布式执行）
└── 技能清单（标准化命令）
```

**关系**: v0.2.3 在 v0.2.1 基础上添加工作流能力

---

## 🎯 成功标准

### Phase 1: Git 工作流

- ✅ `main` 分支始终干净
- ✅ 失败自动回滚
- ✅ 分支命名规范

### Phase 2: DAG 调度

- ✅ 多节点并发执行
- ✅ 依赖管理正确
- ✅ 状态实时回传

### Phase 3: 技能清单

- ✅ LLM 使用预定义命令
- ✅ 与 AGENTFLOW.md 整合
- ✅ 参数模板正确展开

---

## 📝 决策记录

### DR-001: 延后 Tree-sitter 索引

**日期**: 2026-01-28
**决策**: 将 Tree-sitter 索引延后到 v0.3.x
**理由**:
- 非核心功能
- 实现成本高
- 当前无性能问题
- 维护成本不可接受

### DR-002: 整合技能清单到 AGENTFLOW.md

**日期**: 2026-01-28
**决策**: 不使用独立的 skills.json
**理由**:
- 减少配置文件数量
- 统一项目配置入口
- 降低用户学习成本

### DR-003: 分阶段实施

**日期**: 2026-01-28
**决策**: v0.2.3 分为 3 个 Phase
**理由**:
- 降低风险
- 便于测试验证
- 支持并行开发

---

## 🚀 下一步行动

### 立即行动

1. **创建 `feature/0.2.3` 分支**
   ```bash
   git checkout -b feature/0.2.3
   ```

2. **实施 Phase 1: Git 工作流**
   - 创建 `rust/agentflow-core/src/git/branch_manager.rs`
   - 集成到 TaskExecutor
   - 编写单元测试

3. **准备 Cloud Master 基础**
   - 设置 HTTP 服务框架
   - 定义 API 规范

### 本周目标

- ✅ 完成 Phase 1（Git 工作流）
- 📅 开始 Phase 2（DAG 调度器）基础设计

### 下周目标

- ✅ 完成 Phase 2（DAG 调度器）
- ✅ 完成 Phase 3（技能清单）
- ✅ 集成测试

---

## 📚 相关文档

- [v0.2.3 迭代计划](v0.2.3_ITERATION_PLAN.md) - 详细实施计划
- [v0.2.3 原始需求](../v0.2.3.md) - 需求描述
- [VERSION_ROADMAP](../VERSION_ROADMAP.md) - 版本路线图

---

**最后更新**: 2026-01-28
**文档版本**: 1.0
