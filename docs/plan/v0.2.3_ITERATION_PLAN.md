# AgentFlow v0.2.3 - å·¥ä½œæµè‡ªåŠ¨åŒ–ä¸åˆ†å¸ƒå¼è°ƒåº¦

**æ—¥æœŸ**: 2026-01-28
**åˆ†æ”¯**: `feature/0.2.3` (å¾…åˆ›å»º)
**å‰ç½®ç‰ˆæœ¬**: v0.2.1 (Skill å¼•å¯¼ç³»ç»Ÿ âœ…)

---

## ğŸ“‹ ç‰ˆæœ¬ç›®æ ‡

### æ ¸å¿ƒç†å¿µ

**"Rust æ˜¯æŒ‡æŒ¥å®˜å’Œæƒ…æŠ¥å®˜ï¼ŒClaude CLI æ˜¯æ‰§è¡Œå£«å…µ"**

- **Rust**: è´Ÿè´£ç¯å¢ƒå‡†å¤‡ã€æƒ…æŠ¥æ”¶é›†ã€Prompt ç»„è£…ã€å·¥ä½œæµæ§åˆ¶
- **Claude CLI**: è´Ÿè´£ä»£ç ç”Ÿæˆã€æ–‡ä»¶ä¿®æ”¹ã€å‘½ä»¤æ‰§è¡Œ

### ç‰ˆæœ¬å®šä½

v0.2.3 æ˜¯ **å·¥ä½œæµè‡ªåŠ¨åŒ–ç‰ˆæœ¬**ï¼Œåœ¨ v0.2.1 Skill å¼•å¯¼åŸºç¡€ä¸Šï¼š
- âœ… è‡ªåŠ¨åŒ– Git å·¥ä½œæµï¼ˆä¿æŠ¤ main åˆ†æ”¯ï¼‰
- âœ… å®ç°åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼ˆDAGï¼‰
- âœ… å¢å¼ºæŠ€èƒ½æ¸…å•ï¼ˆæ ‡å‡†åŒ–å‘½ä»¤ï¼‰
- â¸ï¸ æš‚ç¼“ Tree-sitter ç´¢å¼•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼Œéå¿…éœ€ï¼‰

---

## ğŸ¯ åŠŸèƒ½ä¼˜å…ˆçº§

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | é¢„è®¡å·¥æœŸ | ä»·å€¼ |
|------|--------|--------|----------|------|
| **Git å·¥ä½œæµè‡ªåŠ¨åŒ–** | ğŸ”´ P0 | ğŸŸ¢ Low | 2-3 å¤© | ä¿æŠ¤ main åˆ†æ”¯ |
| **DAG ä»»åŠ¡è°ƒåº¦** | ğŸ”´ P0 | ğŸŸ¡ Medium | 5-7 å¤© | åˆ†å¸ƒå¼æ‰§è¡Œæ ¸å¿ƒ |
| **åŠ¨æ€æŠ€èƒ½æ¸…å•** | ğŸŸ¡ P1 | ğŸŸ¢ Low | 1-2 å¤© | æ ‡å‡†åŒ–å‘½ä»¤ |
| **Tree-sitter ç´¢å¼•** | ğŸŸ¢ P2 | ğŸ”´ High | 10+ å¤© | æ€§èƒ½ä¼˜åŒ–ï¼ˆå»¶åï¼‰ |

**å»ºè®®**: æœ¬ç‰ˆæœ¬ä¸“æ³¨äº P0 åŠŸèƒ½ï¼ŒP1 ä½œä¸ºå¢å¼ºï¼ŒP2 å»¶ååˆ° v0.3.x

---

## ğŸ“… ä¸‰é˜¶æ®µè¿­ä»£è®¡åˆ’

### ğŸš€ Phase 1: Git å·¥ä½œæµè‡ªåŠ¨åŒ– (Days 1-3)

**ç›®æ ‡**: ä¿æŠ¤ `main` åˆ†æ”¯ï¼Œæ‰€æœ‰ CLI æ‰§è¡Œåœ¨éš”ç¦»çš„ feature åˆ†æ”¯

#### 1.1 Git åˆ†æ”¯ç®¡ç†å™¨

**æ–‡ä»¶**: `rust/agentflow-core/src/git/branch_manager.rs`

**åŠŸèƒ½**:
```rust
pub struct BranchManager {
    repo: git2::Repository,
}

impl BranchManager {
    /// åˆ›å»ºä»»åŠ¡åˆ†æ”¯
    pub async fn create_task_branch(&self) -> Result<String> {
        // 1. git checkout main
        // 2. git pull
        // 3. git checkout -b agentflow/task-{timestamp}
        // 4. è¿”å›åˆ†æ”¯å
    }

    /// æ¸…ç†å¤±è´¥åˆ†æ”¯
    pub async fn cleanup_on_failure(&self, branch_name: &str) -> Result<()> {
        // 1. git checkout main
        // 2. git branch -D {branch_name}
    }

    /// æ¨é€æˆåŠŸåˆ†æ”¯
    pub async fn push_on_success(&self, branch_name: &str) -> Result<()> {
        // git push -u origin {branch_name}
    }
}
```

#### 1.2 é›†æˆåˆ° TaskExecutor

**ä¿®æ”¹**: `rust/agentflow-core/src/executor/mod.rs`

**æµç¨‹**:
```rust
pub async fn execute(&self, prompt: &str) -> Result<ExecutionResult> {
    // 1. åˆ›å»º feature åˆ†æ”¯
    let branch_name = self.git_manager.create_task_branch().await?;

    // 2. æ‰§è¡Œ CLI
    let result = self.cli_runner.execute(prompt).await;

    // 3. æ ¹æ®ç»“æœå¤„ç†
    match result {
        Ok(_) => self.git_manager.push_on_success(&branch_name).await,
        Err(_) => self.git_manager.cleanup_on_failure(&branch_name).await,
    }
}
```

#### 1.3 éªŒæ”¶æ ‡å‡†

- âœ… CLI æ‰§è¡Œå‰è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
- âœ… åˆ†æ”¯å‘½å: `agentflow/task-{timestamp}`
- âœ… å¤±è´¥åæ— æ®‹ç•™åˆ†æ”¯
- âœ… `main` åˆ†æ”¯å§‹ç»ˆä¿æŒå¹²å‡€

**äº§å‡º**:
- `rust/agentflow-core/src/git/branch_manager.rs`
- é›†æˆåˆ° TaskExecutor
- å•å…ƒæµ‹è¯•

---

### ğŸŒ Phase 2: DAG ä»»åŠ¡è°ƒåº¦å™¨ (Days 4-10)

**ç›®æ ‡**: å®ç°åˆ†å¸ƒå¼ä»»åŠ¡ç¼–æ’ï¼Œæ”¯æŒä¾èµ–ç®¡ç†å’Œå¹¶å‘æ‰§è¡Œ

#### 2.1 DAG æ•°æ®ç»“æ„

**æ–‡ä»¶**: `rust/agentflow-core/src/scheduler/dag.rs`

```rust
/// ä»»åŠ¡èŠ‚ç‚¹
pub struct TaskNode {
    pub id: String,
    pub target_node: String,  // ç›®æ ‡èŠ‚ç‚¹ ID
    pub description: String,
    pub prompt: String,
    pub deps: Vec<String>,    // ä¾èµ–çš„ä»»åŠ¡ ID
    pub status: TaskStatus,
}

/// ä»»åŠ¡çŠ¶æ€
pub enum TaskStatus {
    Pending,
    Running,
    Completed,
    Failed,
}

/// DAG ä»»åŠ¡å›¾
pub struct TaskDAG {
    pub nodes: HashMap<String, TaskNode>,
    pub adj_list: HashMap<String, Vec<String>>,  // é‚»æ¥è¡¨
}

impl TaskDAG {
    /// æ·»åŠ ä»»åŠ¡
    pub fn add_task(&mut self, task: TaskNode) -> Result<()> {
        // éªŒè¯ä¾èµ–å­˜åœ¨
        // æ›´æ–°é‚»æ¥è¡¨
    }

    /// è·å–å¯æ‰§è¡Œä»»åŠ¡ï¼ˆæ— ä¾èµ–æˆ–ä¾èµ–å·²å®Œæˆï¼‰
    pub fn get_ready_tasks(&self) -> Vec<String> {
        // è¿”å›æ‰€æœ‰ Pending çŠ¶æ€ä¸”ä¾èµ–å·²å®Œæˆ çš„ä»»åŠ¡
    }

    /// æ ‡è®°ä»»åŠ¡å®Œæˆ
    pub fn mark_completed(&mut self, task_id: &str) -> Result<()> {
        // æ›´æ–°çŠ¶æ€ï¼Œè§¦å‘åç»­ä»»åŠ¡
    }
}
```

#### 2.2 HTTP ä»»åŠ¡åˆ†å‘ API

**æ–‡ä»¶**: `rust/agentflow-core/src/scheduler/distributor.rs`

```rust
/// ä»»åŠ¡åˆ†å‘å™¨
pub struct TaskDistributor {
    client: reqwest::Client,
    nodes: HashMap<String, NodeInfo>,
}

impl TaskDistributor {
    /// åˆ†å‘å•ä¸ªä»»åŠ¡åˆ°æŒ‡å®šèŠ‚ç‚¹
    pub async fn dispatch_task(
        &self,
        node_id: &str,
        task: &TaskNode,
    ) -> Result<ExecutionResult> {
        // POST http://{node}/api/v1/tasks
        // Body: { id, description, prompt }
    }

    /// æ‰¹é‡åˆ†å‘ï¼ˆå¹¶å‘ï¼‰
    pub async fn dispatch_batch(
        &self,
        tasks: Vec<(String, TaskNode)>,  // (node_id, task)
    ) -> Vec<Result<ExecutionResult>> {
        // å¹¶å‘å‘é€ï¼Œä½¿ç”¨ futures::future::join_all
    }
}
```

#### 2.3 è¾¹ç¼˜èŠ‚ç‚¹æ‰§è¡Œå™¨

**æ–‡ä»¶**: `rust/agentflow-core/src/scheduler/executor.rs`

**API ç«¯ç‚¹**:
```rust
// POST /api/v1/tasks
pub async fn create_task(Json(task): Json<TaskNode>) -> Result<Json<TaskStatus>> {
    // 1. åˆ›å»º TaskExecutor
    // 2. æ‰§è¡Œ CLI
    // 3. è¿”å›çŠ¶æ€
}

// GET /api/v1/tasks/{id}/status
pub async fn get_task_status(Path(id): Path<String>) -> Json<TaskStatus> {
    // è¿”å›ä»»åŠ¡çŠ¶æ€
}
```

#### 2.4 çŠ¶æ€æœºä¸ä¾èµ–è§¦å‘

**æ–‡ä»¶**: `rust/agentflow-core/src/scheduler/coordinator.rs`

```rust
/// åè°ƒå™¨ï¼šCloud Master è¿è¡Œ
pub struct Coordinator {
    dag: TaskDAG,
    distributor: TaskDistributor,
}

impl Coordinator {
    /// è¿è¡Œ DAG
    pub async fn run(&mut self) -> Result<()> {
        loop {
            // 1. è·å–å¯æ‰§è¡Œä»»åŠ¡
            let ready_tasks = self.dag.get_ready_tasks();

            // 2. åˆ†å‘åˆ°å¯¹åº”èŠ‚ç‚¹
            self.distributor.dispatch_batch(ready_tasks).await;

            // 3. ç›‘å¬ä»»åŠ¡å®Œæˆ
            // 4. æ ‡è®°å®Œæˆï¼Œè§¦å‘åç»­ä»»åŠ¡

            // 5. å¦‚æœæ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œé€€å‡º
            if self.dag.all_completed() {
                break;
            }

            tokio::time::sleep(Duration::from_secs(1)).await;
        }
    }
}
```

#### 2.5 éªŒæ”¶æ ‡å‡†

- âœ… DAG èƒ½æ­£ç¡®è§£æä¾èµ–å…³ç³»
- âœ… æ— ä¾èµ–ä»»åŠ¡å¹¶å‘æ‰§è¡Œ
- âœ… ä¾èµ–å¤±è´¥æ—¶ï¼Œåç»­ä»»åŠ¡ä¸è§¦å‘
- âœ… ä»»åŠ¡çŠ¶æ€å®æ—¶å›ä¼ 
- âœ… æ”¯æŒå¤šèŠ‚ç‚¹ï¼ˆWindows + Linuxï¼‰

**äº§å‡º**:
- `rust/agentflow-core/src/scheduler/` æ¨¡å—
- Cloud Master HTTP æœåŠ¡
- Edge Node æ‰§è¡Œå™¨ API
- é›†æˆæµ‹è¯•

---

### ğŸ”§ Phase 3: åŠ¨æ€æŠ€èƒ½æ¸…å•å¢å¼º (Days 11-12)

**ç›®æ ‡**: æ ‡å‡†åŒ–å‘½ä»¤ï¼Œé¿å… LLM "å‘æ˜"å‘½ä»¤

#### 3.1 æŠ€èƒ½å®šä¹‰æ ¼å¼

**æ–‡ä»¶**: `skills.json` (é¡¹ç›®æ ¹ç›®å½•)

```json
{
  "version": "1.0",
  "skills": {
    "compile": {
      "desc": "ç¼–è¯‘é¡¹ç›®",
      "cmd_template": "msbuild {project}.sln /p:Configuration={config}",
      "params": {
        "project": { "type": "string", "default": "AgentFlow" },
        "config": { "type": "enum", "values": ["Debug", "Release"], "default": "Release" }
      }
    },
    "test": {
      "desc": "è¿è¡Œæµ‹è¯•",
      "cmd_template": "cargo test --package {package}",
      "params": {
        "package": { "type": "string", "required": true }
      }
    }
  }
}
```

#### 3.2 æŠ€èƒ½è¯»å–ä¸ Prompt æ³¨å…¥

**æ–‡ä»¶**: `rust/agentflow-core/src/skills/loader.rs`

```rust
pub struct SkillLoader {
    skills: HashMap<String, Skill>,
}

impl SkillLoader {
    /// ä» skills.json åŠ è½½
    pub fn load(path: &Path) -> Result<Self> {
        // è¯»å–å¹¶è§£æ JSON
    }

    /// è½¬æ¢ä¸º Prompt ç‰‡æ®µ
    pub fn to_prompt_section(&self) -> String {
        let mut sections = Vec::new();
        sections.push("## Available Skills\n".to_string());
        sections.push("ä½ å¿…é¡»ä½¿ç”¨ä»¥ä¸‹é¢„å®šä¹‰æŠ€èƒ½ï¼Œä¸¥ç¦è‡ªå·±å‘æ˜å‘½ä»¤ï¼š\n".to_string());

        for (name, skill) in &self.skills {
            sections.push(format!(
                "### {}: {}\nå‘½ä»¤: {}\n",
                name, skill.desc, skill.cmd_template
            ));
        }

        sections.join("\n")
    }
}
```

#### 3.3 é›†æˆåˆ° PromptBuilder

**ä¿®æ”¹**: `rust/agentflow-core/src/executor/prompt_builder.rs`

```rust
pub fn build(&self, task: &str, memories: &[MemoryEntry]) -> String {
    let mut parts = Vec::new();

    // 1. ç³»ç»ŸæŒ‡ä»¤
    parts.push(self.build_system_section());

    // 2. æŠ€èƒ½æ¸…å•ï¼ˆæ–°å¢ï¼‰
    if let Some(skills) = self.load_skills() {
        parts.push(skills);
    }

    // 3. é¡¹ç›®é…ç½®
    if let Some(project_config) = self.load_project_config() {
        parts.push(self.build_project_config_section(&project_config));
    }

    // 4. è®°å¿†ä¸Šä¸‹æ–‡
    // ...
}
```

#### 3.4 éªŒæ”¶æ ‡å‡†

- âœ… LLM ä½¿ç”¨é¢„å®šä¹‰å‘½ä»¤ï¼ˆé€šè¿‡æ—¥å¿—éªŒè¯ï¼‰
- âœ… æœªå®šä¹‰çš„æŠ€èƒ½ LLM ä¸ä¼šå°è¯•æ‰§è¡Œ
- âœ… å‚æ•°æ¨¡æ¿æ­£ç¡®å±•å¼€
- âœ… ä¸ AGENTFLOW.md æ— å†²çª

**äº§å‡º**:
- `rust/agentflow-core/src/skills/` æ¨¡å—
- `skills.json` ç¤ºä¾‹æ–‡ä»¶
- å¢å¼ºçš„ PromptBuilder

---

## â¸ï¸ å»¶ååˆ° v0.3.x

### Tree-sitter ç¬¦å·ç´¢å¼•

**å»¶åç†ç”±**:
1. **éæ ¸å¿ƒåŠŸèƒ½**: æ€§èƒ½ä¼˜åŒ–ï¼Œä¸å½±å“åŠŸèƒ½
2. **å¤æ‚åº¦é«˜**: Tree-sitter é›†æˆæˆæœ¬é«˜
3. **æ”¶ç›Šä¸æ˜æ˜¾**: ä¸­å°å‹é¡¹ç›®ä¸éœ€è¦
4. **ç»´æŠ¤æˆæœ¬**: éœ€è¦è·Ÿéšè¯­è¨€è¯­æ³•æ›´æ–°

**æœªæ¥è§¦å‘æ¡ä»¶**:
- é¡¹ç›®ä»£ç è¶…è¿‡ 10 ä¸‡è¡Œ
- CLI æ‰§è¡Œæ—¶é—´ > 30 ç§’
- Token æˆæœ¬æ˜¾è‘—ä¸Šå‡

---

## ğŸ“Š ä¾èµ–å…³ç³»å›¾

```
v0.2.1 (Skill å¼•å¯¼ç³»ç»Ÿ)
    â†“
v0.2.3 (å·¥ä½œæµè‡ªåŠ¨åŒ–)
    â”œâ”€â”€ Phase 1: Git å·¥ä½œæµ â†’ ç‹¬ç«‹ï¼Œå¯å¹¶è¡Œ
    â”œâ”€â”€ Phase 2: DAG è°ƒåº¦ â†’ ä¾èµ– Phase 1 (åˆ†æ”¯éš”ç¦»)
    â””â”€â”€ Phase 3: æŠ€èƒ½æ¸…å• â†’ ç‹¬ç«‹ï¼Œå¯å¹¶è¡Œ
    â†“
v0.3.0 (ç”Ÿäº§å°±ç»ª)
    â”œâ”€â”€ Tree-sitter ç´¢å¼•
    â”œâ”€â”€ Web UI
    â””â”€â”€ æ€§èƒ½ç›‘æ§
```

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### Phase 1: Git å·¥ä½œæµ

- [ ] åˆ†æ”¯è‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†
- [ ] `main` åˆ†æ”¯ä¿æŠ¤
- [ ] å¤±è´¥å›æ»š
- [ ] æ—¥å¿—å®Œæ•´è®°å½•

### Phase 2: DAG è°ƒåº¦

- [ ] DAG æ­£ç¡®è§£æ
- [ ] å¹¶å‘æ‰§è¡Œ
- [ ] ä¾èµ–ç®¡ç†
- [ ] å¤šèŠ‚ç‚¹æ”¯æŒ
- [ ] çŠ¶æ€å›ä¼ 

### Phase 3: æŠ€èƒ½æ¸…å•

- [ ] JSON è§£ææ­£ç¡®
- [ ] Prompt æ³¨å…¥ç”Ÿæ•ˆ
- [ ] LLM éµå¾ªé¢„å®šä¹‰å‘½ä»¤
- [ ] å‚æ•°æ¨¡æ¿å±•å¼€

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶

```
rust/agentflow-core/src/
â”œâ”€â”€ git/
â”‚   â””â”€â”€ branch_manager.rs         # Git åˆ†æ”¯ç®¡ç†
â”œâ”€â”€ scheduler/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ dag.rs                    # DAG æ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ distributor.rs            # ä»»åŠ¡åˆ†å‘
â”‚   â”œâ”€â”€ coordinator.rs            # åè°ƒå™¨
â”‚   â””â”€â”€ executor.rs               # è¾¹ç¼˜èŠ‚ç‚¹æ‰§è¡Œå™¨
â””â”€â”€ skills/
    â”œâ”€â”€ mod.rs
    â”œâ”€â”€ loader.rs                 # æŠ€èƒ½åŠ è½½å™¨
    â””â”€â”€ templates/
        â””â”€â”€ skills.json.example    # æŠ€èƒ½å®šä¹‰ç¤ºä¾‹
```

### ä¿®æ”¹æ–‡ä»¶

```
rust/agentflow-core/src/
â”œâ”€â”€ executor/
â”‚   â””â”€â”€ mod.rs                    # é›†æˆ Git å·¥ä½œæµ
â””â”€â”€ lib.rs                        # å¯¼å‡ºæ–°æ¨¡å—
```

---

## ğŸš€ å¼€å‘æ—¶é—´çº¿

| Week | Phase | ä»»åŠ¡ | çŠ¶æ€ |
|------|-------|------|------|
| Week 1 | Phase 1 | Git å·¥ä½œæµè‡ªåŠ¨åŒ– | ğŸ“… è®¡åˆ’ä¸­ |
| Week 1-2 | Phase 2 | DAG ä»»åŠ¡è°ƒåº¦å™¨ | ğŸ“… è®¡åˆ’ä¸­ |
| Week 2 | Phase 3 | åŠ¨æ€æŠ€èƒ½æ¸…å• | ğŸ“… è®¡åˆ’ä¸­ |
| Week 2 | Testing | é›†æˆæµ‹è¯•å’Œä¿®å¤ | ğŸ“… è®¡åˆ’ä¸­ |

---

## ğŸ‰ é¢„æœŸæˆæœ

v0.2.3 å®Œæˆåï¼ŒAgentFlow å°†å…·å¤‡ï¼š

1. âœ… **å®‰å…¨çš„ Git å·¥ä½œæµ** - main åˆ†æ”¯å§‹ç»ˆå¹²å‡€
2. âœ… **åˆ†å¸ƒå¼ä»»åŠ¡æ‰§è¡Œ** - å¤šèŠ‚ç‚¹å¹¶å‘ï¼Œä¾èµ–ç®¡ç†
3. âœ… **æ ‡å‡†åŒ–å‘½ä»¤** - LLM ä¸å†"å‘æ˜"å‘½ä»¤
4. âœ… **å®Œæ•´çš„æŒ‡æŒ¥ä½“ç³»** - Rust æŒ‡æŒ¥ï¼ŒCLI æ‰§è¡Œ

**ä¸‹ä¸€ç‰ˆæœ¬ (v0.3.0)** å°†èšç„¦äºæ€§èƒ½ä¼˜åŒ–å’Œ Web UIã€‚

---

**æœ€åæ›´æ–°**: 2026-01-28
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
