# v0.3.0 需求分析与决策记录

**日期**: 2026-01-28
**状态**: 需求分析完成，待评审

---

## 1. 需求概述

v0.3.0 计划实现两大模块：
1. **智谱清言智能体接入** - 手机/语音指令网关
2. **大屏驾驶舱** - 实时监控与可视化

---

## 2. 模块一：智谱清言接入

### 2.1 需求分析

#### 核心功能
- Webhook 接口：`POST /api/v1/webhook/zhipu`
- 鉴权机制：Token 校验、IP 白名单
- 意图解析：调用本地 Claude CLI 解析用户指令
- 任务分发：转换为内部 Task 推送给目标 Node

#### 架构图
```
用户(手机) → 智谱清言 → Cloud Master → Claude CLI → 任务分发 → Edge Nodes
```

### 2.2 合理性评估

✅ **非常合理** - 理由如下：

1. **补全输入闭环**
   - 当前只能通过 CLI 手动触发任务
   - 智谱清言提供手机/语音入口，随时随地触发任务
   - 符合"远程指挥，本地执行"的使用场景

2. **技术可行性高**
   - Webhook 接口简单（Axum 框架）
   - 意图解析复用现有 CLI 基础设施
   - 无需额外依赖外部服务

3. **核心约束合理**
   - "所有代码执行必须通过本地 claude cli"
   - "智谱清言仅作为指令传输通道"
   - 保证了系统安全性

4. **与现有架构完美契合**
   - AgentFlow 已有 Cloud Master（Axum Server）
   - 已有 Claude CLI 调度机制
   - 只需新增 Webhook 端点

### 2.3 风险评估

| 风险 | 级别 | 应对措施 |
|------|------|----------|
| Webhook 安全暴露 | 🔴 高 | Token + IP 白名单 + 速率限制 |
| 意图解析不准确 | 🟡 中 | Prompt 优化 + 结构化输出强制 |
| 异步状态查询 | 🟢 低 | MVP 阶段可简化为仅触发 |

---

## 3. 模块二：大屏驾驶舱

### 3.1 需求分析

#### 核心功能
- **节点拓扑图**：展示 Master-Edges 连接状态
- **实时任务流**：流式显示 CLI 执行日志（带颜色）
- **智能记忆库**：可视化 conversation_insights
- **资源监控**：内存、连接数、Token 消耗

#### 技术栈选项
- **方案 A**：Tauri (Rust 后端 + Web 前端) - 推荐用于桌面端
- **方案 B**：Vite + React (纯 Web) - 跨平台访问

### 3.2 合理性评估

✅ **合理** - 理由如下：

1. **透明化"黑盒"运行**
   - 当前 CLI 执行过程不可见
   - 大屏提供实时可视性，符合 DevOps 理念

2. **实时日志流** (核心功能)
   - 直接展示 CLI Stdout（带颜色分类）
   - 技术可行：WebSocket/SSE 广播
   - 价值高：调试、监控、演示

3. **节点拓扑图** (重要功能)
   - 直观展示分布式节点状态
   - 便于监控集群健康度

4. **智能记忆库可视化** (可选功能)
   - 增值功能，优先级可降低

### 3.3 风险评估

| 风险 | 级别 | 应对措施 |
|------|------|----------|
| 日志刷屏导致卡顿 | 🟡 中 | 虚拟滚动 + 频率限制 |
| WebSocket 连接管理 | 🟡 中 | 连接池 + 心跳检测 |
| 前端技术选型 | 🟢 低 | 先做 Tauri MVP，后续抽离 |

---

## 4. 优先级排序

### P0 (立即实现) - v0.3.0 Phase 1
- ✅ **智谱清言 Webhook 接入**
  - 理由：补全输入闭环，核心功能
  - 工作量：2-3 天
  - 依赖：无

### P1 (尽快实现) - v0.3.0 Phase 2
- ✅ **基础大屏 (Tauri)**
  - 理由：透明化运行状态，实时日志流
  - 工作量：3-4 天
  - 依赖：Phase 1 完成

### P2 (增值功能) - v0.3.0 Phase 3
- 🟡 **智能记忆库可视化**
  - 理由：可选功能，不阻塞核心流程
  - 工作量：2 天
  - 依赖：Phase 2 完成

### P3 (未来迭代) - v0.3.1+
- ⏸️ **跨平台 Web 版**
  - 理由：Tauri MVP 已满足桌面需求
  - 工作量：3-5 天（重构前端）
  - 依赖：v0.3.0 完成

---

## 5. 技术决策

### 决策 1：Webhook 安全机制

**方案**：多层防护
1. **Token 校验**：`Authorization: Bearer <secret>`
2. **IP 白名单**：仅允许智谱服务器 IP
3. **速率限制**：防 DDoS（可选）

**实现**：
```rust
// axum 中间件
async fn webhook_auth(
    State(secret): State<String>,
    headers: HeaderMap,
) -> Result<(), StatusCode> {
    let auth = headers.get("Authorization")
        .ok_or(StatusCode::UNAUTHORIZED)?;

    if auth != format!("Bearer {}", secret) {
        return Err(StatusCode::FORBIDDEN);
    }

    Ok(())
}
```

### 决策 2：实时日志流技术

**方案**：WebSocket (优于 SSE)
- 理由：双向通信、原生支持、社区活跃
- 库选择：`tokio-tungstenite` 或 `axum::extract::ws`

**实现**：
```rust
// Rust 后端广播
async fn broadcast_log(ws_tx: BroadcastSender, log_line: LogLine) {
    ws_tx.send(log_line).await?;
}

// 前端接收
ws.onmessage = (event) => {
    const log = JSON.parse(event.data);
    appendLogToTerminal(log);
}
```

### 决策 3：大屏技术栈

**Phase 2 (MVP)**：Tauri
- 理由：
  1. 复用 Rust 代码库（直接内存调用）
  2. 性能极佳，打包体积小
  3. 适合桌面常驻

**Phase 3 (跨平台)**：抽离为 Web
- 理由：
  1. 满足移动端访问需求
  2. 灵活部署
- 策略：前端逻辑复用，后端改用 REST API

---

## 6. 实施建议

### 阶段划分

#### Phase 1: Webhook 接入 (MVP)
**目标**：能通过智谱清言触发本地简单任务

**任务清单**：
- [ ] 实现 Webhook Server (Axum)
- [ ] 实现签名校验中间件
- [ ] 接通 Webhook → CLI Planner → 任务分发流程
- [ ] 智谱清言配置测试

**验收标准**：
```bash
# 通过智谱清言发送："跑个测试"
# 触发流程：
1. Webhook 接收请求
2. 调用 CLI 解析意图
3. 分发任务到节点
4. 返回 task_id
```

**预估工作量**：2-3 天

---

#### Phase 2: 基础大屏 (Tauri)
**目标**：能在电脑上看到节点状态和静态日志

**任务清单**：
- [ ] 搭建 Tauri 项目框架
- [ ] 实现 `/api/v1/nodes` 接口
- [ ] 前端绘制节点拓扑图（使用 React Flow 或 D3）
- [ ] 实现任务列表查看

**验收标准**：
- 启动 Tauri 应用
- 看到节点拓扑图
- 点击节点查看历史任务

**预估工作量**：3-4 天

---

#### Phase 3: 实时流传输
**目标**：大屏能实时滚动显示 CLI 执行过程

**任务清单**：
- [ ] Rust 侧实现 WebSocket 广播
- [ ] TaskExecutor 将 CLI Stdout 逐行推送到 Channel
- [ ] 前端实现日志流组件（虚拟滚动）
- [ ] 颜色分类（用户输入/思考/命令/修改）

**验收标准**：
- 大屏实时显示日志滚动
- 颜色区分清晰
- 无卡顿

**预估工作量**：2-3 天

---

#### Phase 4: 记忆可视化 (可选)
**目标**：数据层可视化

**任务清单**：
- [ ] 接入 SQLite conversation_insights
- [ ] 展示知识点检索界面
- [ ] 前端 UI 美化

**预估工作量**：2 天

---

## 7. 关键风险与应对

| 风险 | 级别 | 应对措施 |
|------|------|----------|
| **Webhook 安全** | 🔴 高 | 1. 强 Token 校验；2. IP 白名单；3. 请求频率限制 |
| **状态同步延迟** | 🟡 中 | 使用 WebSocket 推送代替轮询，确保实时性 |
| **大屏性能** | 🟡 中 | 前端实现虚拟滚动；后端限制日志推送频率 |
| **CLI 崩溃** | 🟡 中 | Rust 监控进程退出码，自动重试或记录失败状态 |

---

## 8. 与现有版本的关系

### v0.2.3 (进行中)
- ✅ Git 工作流自动化
- 🔄 DAG 任务调度器

### v0.3.0 (本次)
- 🆕 智谱清言接入
- 🆕 大屏监控

**依赖关系**：
```
v0.2.3 (Git + DAG) → 为 v0.3.0 提供分布式任务执行基础
                    ↓
v0.3.0 (Webhook + 大屏) → 提供输入闭环 + 可视化
```

---

## 9. 建议实施顺序

### 推荐方案：Phase 1 → Phase 2 → Phase 3

1. **先完成 v0.2.3 Phase 1 (Git 工作流)**
   - 当前已完成 BranchManager，待集成到 execute()
   - 预计 1 天完成集成

2. **启动 v0.3.0 Phase 1 (Webhook)**
   - 优先级最高，补全输入闭环
   - 预计 2-3 天

3. **并行开发**
   - v0.2.3 Phase 2 (DAG 调度器)
   - v0.3.0 Phase 2 (基础大屏)

**理由**：
- Webhook 是核心功能，依赖少，可快速见效
- DAG 调度器与大屏开发可并行
- 实时日志流（Phase 3）依赖基础大屏完成

---

## 10. 下一步行动

### 立即可做

1. **创建分支**：`feature/0.3.0-phase1`
2. **实现 Webhook 接口**：
   - `rust/agentflow-master/src/webhook/zhipu.rs`
   - Token 校验中间件
   - 接入 CLI Planner
3. **测试流程**：
   - 本地 curl 测试
   - 智谱清言配置测试

### 技术预研

1. **Tauri 入门**：
   - 官方文档：https://tauri.app/
   - 示例项目：Tauri + React

2. **WebSocket 选型**：
   - Axum ws: https://docs.rs/axum/latest/axum/extract/ws/index.html
   - tokio-tungstenite: https://docs.rs/tokio-tungstenite/

---

**最后更新**: 2026-01-28
**文档版本**: 1.0
