这是一个系统级的架构改造计划，核心是将 AgentFlow 从“项目附属品”升级为“用户级基础设施”，同时解决多项目管理难题。
你可以直接将以下内容作为 Issue 发给 Agent。
---
# Issue: AgentFlow 架构重构 - 全局化与多项目支持
**标签**: `refactor`, `critical`, `deployment`
**背景**:
目前的 AgentFlow 将数据库和配置文件散落在每个项目目录下（如 `{PROJECT}/.agentflow/agentflow.db`），导致多项目时数据割裂、难以管理。本计划旨在将 AgentFlow 改造为标准的用户级 CLI 工具：**二进制全局部署，数据集中存储，项目仅保留轻量级配置。**
**核心变更**:
1.  **数据路径迁移**: 所有 SQLite 数据库、日志、配置统一迁移至 `~/.agentflow/` (遵循 XDG 规范)。
2.  **数据库 Schema 升级**: 引入 `project_id` 字段，在单一数据库中隔离不同项目的数据。
3.  **部署方式**: 二进制文件安装至全局 PATH，不再依赖项目目录。
4.  **交互提示**: 在技能初始化/安装时，自动检测环境并引导用户。
---
## Phase 1: 基础设施与路径定义
**目标**: 建立跨平台的路径解析逻辑，不再硬编码相对路径。
### 1.1 引入依赖
在 `Cargo.toml` 中加入：
```toml
[dependencies]
dirs = "5.0" # 用于获取系统标准目录
uuid = { version = "1.0", features = ["v4"] }
```
### 1.2 实现路径管理模块
新建 `rust/agentflow-core/src/paths.rs`:
```rust
use std::path::PathBuf;
use dirs::*;
pub struct AgentFlowPaths;
impl AgentFlowPaths {
    /// 获取用户数据目录: ~/.agentflow/ (Linux/Mac) 或 %APPDATA%/agentflow/ (Windows)
    pub fn data_dir() -> PathBuf {
        data_local_dir()
            .unwrap_or_else(|| PathBuf::from("."))
            .join("agentflow")
    }
    /// 主数据库路径
    pub fn main_db() -> PathBuf {
        Self::data_dir().join("agentflow.db")
    }
    /// 记忆/向量数据库路径
    pub fn memory_db() -> PathBuf {
        Self::data_dir().join("memory.db")
    }
    /// 全局日志目录
    pub fn log_dir() -> PathBuf {
        Self::data_dir().join("logs")
    }
    
    /// 确保目录存在
    pub fn ensure() -> Result<()> {
        fs::create_dir_all(Self::data_dir())?;
        fs::create_dir_all(Self::log_dir())?;
        Ok(())
    }
}
```
---
## Phase 2: 数据库 Schema 升级
**目标**: 引入 `project_id`，支持多项目数据共存。
### 2.1 Migration 脚本
在初始化数据库时执行以下 SQL 变更：
```sql
-- 1. 为所有核心表添加 project_id 字段
ALTER TABLE tasks ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';
ALTER TABLE conversation_sources ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';
ALTER TABLE conversation_insights ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';
ALTER TABLE code_symbols ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';
-- 2. 建立索引以加速查询
CREATE INDEX IF NOT EXISTS idx_tasks_project ON tasks(project_id);
CREATE INDEX IF NOT EXISTS idx_insights_project ON conversation_insights(project_id);
```
### 2.2 数据访问层 (DAL) 改造
修改 `rust/agentflow-core/src/db/mod.rs` 中的所有插入/查询方法。
- **Insert**: 强制要求传入 `project_id: &str`。
- **Query**: 默认添加 `WHERE project_id = ?` 过滤条件。
---
## Phase 3: 项目发现与轻量化配置
**目标**: 项目根目录只保留 `.agentflow/project.toml`，不含数据库。
### 3.1 项目定位逻辑
新建 `rust/agentflow-core/src/project/context.rs`:
```rust
pub struct ProjectContext {
    pub id: String,
    pub root_path: PathBuf,
    pub name: String,
}
impl ProjectContext {
    /// 从当前工作目录向上查找 .agentflow/project.toml
    pub fn discover(cwd: PathBuf) -> Option<Self> {
        // 向上遍历父目录，直到找到包含 .agentflow/project.toml 的目录
        // ...
    }
    
    /// 如果未找到配置，使用路径哈希作为 ID
    pub fn fallback(cwd: PathBuf) -> Self {
        let id = format!("temp-{:x}", md5_compute(&cwd));
        Self { id, root_path: cwd, name: "Unnamed".into() }
    }
}
```
### 3.2 配置文件模板 (`.agentflow/project.toml`)
```toml
[project]
id = "diveadstra-main" # 唯一标识
name = "DiveAdstra"
[agent]
allowed_branches = ["main", "dev"]
```
---
## Phase 4: 技能安装与环境检测提示
**目标**: 在用户执行 `agentflow skill install` 或初始化时，接管环境并提示迁移。
### 4.1 实现检测逻辑
在 `agentflow-cli/src/commands/skill.rs` 的 `install` 子命令中：
```rust
pub fn execute(args: InstallArgs) -> Result<()> {
    // 1. 初始化全局目录 (如果没有)
    AgentFlowPaths::ensure()?;
    // 2. 检测旧结构 (如果当前目录下有 agentflow.db)
    let local_db = PathBuf::from("./.agentflow/agentflow.db");
    if local_db.exists() {
        println!("⚠️  检测到旧版本的项目数据结构。");
        println!("   建议运行 'agentflow admin migrate' 将数据迁移至全局目录 ~/.agentflow/");
    }
    
    // 3. 继续正常的技能安装逻辑
    // ...
}
```
---
## Phase 5: 执行器 改造
**目标**: Node 接收任务时，根据 `repo_path` 动态切换工作目录。
### 5.1 任务 Payload 更新
Master 下发给 Node 的 JSON 结构需包含绝对路径：
```json
{
  "task_id": "123",
  "project_id": "diveadstra-main",
  "repo_path": "/home/user/code/DiveAdstra", // 绝对路径
  "prompt": "..."
}
```
### 5.2 执行流程调整
修改 `TaskExecutor::run`:
```rust
pub async fn run(task: Task) -> Result<()> {
    // 1. 保存当前目录
    let original_dir = std::env::current_dir()?;
    
    // 2. 切换到任务指定的项目目录
    std::env::set_current_dir(&task.repo_path)?;
    
    // 3. 读取 .agentflow/project.toml 确认 project_id
    // ...
    
    // 4. 在此目录下执行 Git 操作 和 Claude CLI
    // ...
    
    // 5. 恢复目录 (或保持，取决于是否常驻)
    std::env::set_current_dir(original_dir)?;
    Ok(())
}
```
---
## Phase 6: 数据迁移工具
**目标**: 提供一键迁移命令，将旧项目的数据导入新系统。
### 6.1 新增命令 `agentflow admin migrate`
功能：
1.  扫描用户指定的目录（或当前目录）。
2.  寻找 `.agentflow/agentflow.db`。
3.  读取旧数据。
4.  根据 `.agentflow/project.toml` 生成 `project_id`（若无则用目录名）。
5.  将数据写入 `~/.agentflow/agentflow.db`，并标记 `project_id`。
6.  备份旧数据库为 `.agentflow/agentflow.db.bak`。
---
## 验收标准
1.  **安装**: 运行 `cargo install --path .` 后，二进制在 PATH 中，任意目录可运行。
2.  **初始化**: 在任意目录运行 `agentflow skill init`，自动在 `~/.agentflow/` 创建数据库，项目根目录仅生成 `project.toml`。
3.  **多项目**:
    - 在 `~/code/A` 生成任务 A。
    - 在 `~/code/B` 生成任务 B。
    - 大屏/查询接口能根据 `project_id` 清晰区分两者数据。
4.  **清理**: 删除某个项目文件夹，不影响 `~/.agentflow/` 的全局数据。
5.  **提示**: 用户在旧项目目录下运行命令时，能看到明确的迁移提示。
