# v0.4.0 è¿­ä»£è®¡åˆ’ï¼šæ¶æ„é‡æ„ä¸å…¨å±€åŒ–

**ç‰ˆæœ¬**: v0.4.0
**ç›®æ ‡**: å°† AgentFlow ä»"é¡¹ç›®é™„å±å“"å‡çº§ä¸º"ç”¨æˆ·çº§åŸºç¡€è®¾æ–½"
**çŠ¶æ€**: è®¡åˆ’ä¸­
**é¢„è®¡å·¥æœŸ**: 15-20 å¤©

---

## ç‰ˆæœ¬ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡

å°† AgentFlow æ”¹é€ ä¸ºæ ‡å‡†çš„ç”¨æˆ·çº§ CLI å·¥å…·ï¼š
- âœ… **å…¨å±€éƒ¨ç½²**ï¼šäºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…è‡³ PATHï¼Œä»»æ„ç›®å½•å¯è¿è¡Œ
- âœ… **æ•°æ®é›†ä¸­**ï¼šæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ `~/.agentflow/`ï¼ˆXDG è§„èŒƒï¼‰
- âœ… **å¤šé¡¹ç›®æ”¯æŒ**ï¼šå•ä¸€æ•°æ®åº“ï¼Œé€šè¿‡ `project_id` éš”ç¦»
- âœ… **è½»é‡é…ç½®**ï¼šé¡¹ç›®ç›®å½•ä»…ä¿ç•™ `.agentflow/project.toml`
- âœ… **å¹³æ»‘è¿ç§»**ï¼šæä¾›ä¸€é”®è¿ç§»å·¥å…·ï¼Œé›¶æ•°æ®ä¸¢å¤±

---

## æ ¸å¿ƒå˜æ›´

### å˜æ›´å‰ (v0.3.x)

```
~/code/ProjectA/
  â””â”€â”€ .agentflow/
      â”œâ”€â”€ agentflow.db      # ç‹¬ç«‹æ•°æ®åº“
      â”œâ”€â”€ memory.db
      â””â”€â”€ logs/

~/code/ProjectB/
  â””â”€â”€ .agentflow/
      â”œâ”€â”€ agentflow.db      # ç‹¬ç«‹æ•°æ®åº“
      â”œâ”€â”€ memory.db
      â””â”€â”€ logs/
```

**é—®é¢˜**ï¼š
- æ•°æ®åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†
- æ— æ³•è·¨é¡¹ç›®æŸ¥è¯¢
- åˆ é™¤é¡¹ç›®ä¸¢å¤±å†å²
- ä¸ç¬¦åˆ CLI å·¥å…·æ ‡å‡†

### å˜æ›´å (v0.4.0)

```
~/.agentflow/                   # å…¨å±€æ•°æ®ç›®å½•
  â”œâ”€â”€ agentflow.db             # ç»Ÿä¸€æ•°æ®åº“ï¼ˆå¸¦ project_idï¼‰
  â”œâ”€â”€ memory.db
  â”œâ”€â”€ logs/
  â””â”€â”€ config/
      â””â”€â”€ agentflow.toml       # å…¨å±€é…ç½®

~/code/ProjectA/
  â””â”€â”€ .agentflow/
      â””â”€â”€ project.toml         # è½»é‡çº§é…ç½®ï¼ˆ10 è¡Œï¼‰

~/code/ProjectB/
  â””â”€â”€ .agentflow/
      â””â”€â”€ project.toml         # è½»é‡çº§é…ç½®
```

**ä¼˜åŠ¿**ï¼š
- æ•°æ®é›†ä¸­ç®¡ç†
- ä¾¿äºå¤‡ä»½å’Œè¿ç§»
- è·¨é¡¹ç›®ç»Ÿè®¡åˆ†æ
- ç¬¦åˆ XDG è§„èŒƒ

---

## å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€è®¾æ–½ä¸è·¯å¾„å®šä¹‰
**å·¥æœŸ**: 1-2 å¤©
**ä¼˜å…ˆçº§**: P0
**çŠ¶æ€**: å¾…å¯åŠ¨

#### ä»»åŠ¡æ¸…å•

**Task 1.1: æ·»åŠ ä¾èµ–**
```toml
[dependencies]
dirs = "5.0"           # è·å–ç³»ç»Ÿæ ‡å‡†ç›®å½•
uuid = { version = "1.0", features = ["v4"] }
```

**Task 1.2: å®ç°è·¯å¾„ç®¡ç†æ¨¡å—**
**æ–‡ä»¶**: `rust/agentflow-core/src/paths.rs`

```rust
use std::path::PathBuf;
use dirs::data_local_dir;
use anyhow::Result;

pub struct AgentFlowPaths;

impl AgentFlowPaths {
    /// è·å–ç”¨æˆ·æ•°æ®ç›®å½•
    /// Linux/Mac: ~/.local/share/agentflow/
    /// Windows: %APPDATA%/agentflow/
    pub fn data_dir() -> PathBuf {
        data_local_dir()
            .unwrap_or_else(|| PathBuf::from("."))
            .join("agentflow")
    }

    /// ä¸»æ•°æ®åº“è·¯å¾„
    pub fn main_db() -> PathBuf {
        Self::data_dir().join("agentflow.db")
    }

    /// è®°å¿†æ•°æ®åº“è·¯å¾„
    pub fn memory_db() -> PathBuf {
        Self::data_dir().join("memory.db")
    }

    /// å…¨å±€æ—¥å¿—ç›®å½•
    pub fn log_dir() -> PathBuf {
        Self::data_dir().join("logs")
    }

    /// å…¨å±€é…ç½®ç›®å½•
    pub fn config_dir() -> PathBuf {
        Self::data_dir().join("config")
    }

    /// ç¡®ä¿æ‰€æœ‰ç›®å½•å­˜åœ¨
    pub fn ensure() -> Result<()> {
        std::fs::create_dir_all(Self::data_dir())?;
        std::fs::create_dir_all(Self::log_dir())?;
        std::fs::create_dir_all(Self::config_dir())?;
        Ok(())
    }
}
```

**Task 1.3: å•å…ƒæµ‹è¯•**
**æ–‡ä»¶**: `rust/agentflow-core/src/paths_tests.rs`

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_data_dir_exists() {
        let dir = AgentFlowPaths::data_dir();
        assert!(dir.ends_with("agentflow"));
    }

    #[test]
    fn test_ensure_creates_dirs() {
        AgentFlowPaths::ensure().unwrap();
        assert!(AgentFlowPaths::data_dir().exists());
        assert!(AgentFlowPaths::log_dir().exists());
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ä»£ç ç¼–è¯‘é€šè¿‡
- âœ… å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… è·¯å¾„åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šæ­£ç¡®

---

### Phase 2: æ•°æ®åº“ Schema å‡çº§
**å·¥æœŸ**: 2-3 å¤©
**ä¼˜å…ˆçº§**: P0
**ä¾èµ–**: Phase 1

#### ä»»åŠ¡æ¸…å•

**Task 2.1: å®ç° Migration è„šæœ¬**
**æ–‡ä»¶**: `rust/agentflow-core/src/database/migrations.rs`

```rust
const MIGRATION_001_ADD_PROJECT_ID: &str = r#"
-- 1. ä¸ºæ‰€æœ‰æ ¸å¿ƒè¡¨æ·»åŠ  project_id å­—æ®µ
ALTER TABLE tasks ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';
ALTER TABLE conversation_sources ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';
ALTER TABLE conversation_insights ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';
ALTER TABLE code_symbols ADD COLUMN project_id TEXT NOT NULL DEFAULT 'default';

-- 2. å»ºç«‹ç´¢å¼•ä»¥åŠ é€ŸæŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_tasks_project ON tasks(project_id);
CREATE INDEX IF NOT EXISTS idx_sources_project ON conversation_sources(project_id);
CREATE INDEX IF NOT EXISTS idx_insights_project ON conversation_insights(project_id);
CREATE INDEX IF NOT EXISTS idx_symbols_project ON code_symbols(project_id);
"#;

pub async fn migrate_add_project_id(db: &SqlitePool) -> Result<()> {
    sqlx::query(MIGRATION_001_ADD_PROJECT_ID)
        .execute(db)
        .await?;
    Ok(())
}
```

**Task 2.2: æ›´æ–°æ•°æ®è®¿é—®å±‚**
**æ–‡ä»¶**: `rust/agentflow-core/src/database/mod.rs`

```rust
impl Database {
    /// æ’å…¥ä»»åŠ¡ï¼ˆå¼ºåˆ¶è¦æ±‚ project_idï¼‰
    pub async fn insert_task(
        &self,
        task_id: &str,
        project_id: &str,  // æ–°å¢å‚æ•°
        prompt: &str,
        // ...
    ) -> Result<()> {
        sqlx::query(
            "INSERT INTO tasks (id, project_id, prompt, ...)
             VALUES (?1, ?2, ?3, ...)"
        )
        .bind(task_id)
        .bind(project_id)  // æ–°å¢
        .bind(prompt)
        .execute(&self.pool)
        .await?;
        Ok(())
    }

    /// æŸ¥è¯¢ä»»åŠ¡ï¼ˆé»˜è®¤è¿‡æ»¤ project_idï¼‰
    pub async fn get_tasks(
        &self,
        project_id: &str,  // æ–°å¢å‚æ•°
        limit: usize,
    ) -> Result<Vec<Task>> {
        let tasks = sqlx::query_as(
            "SELECT * FROM tasks
             WHERE project_id = ?1
             ORDER BY created_at DESC
             LIMIT ?2"
        )
        .bind(project_id)
        .bind(limit as i64)
        .fetch_all(&self.pool)
        .await?;
        Ok(tasks)
    }
}
```

**Task 2.3: ç‰ˆæœ¬ç®¡ç†**
**æ–‡ä»¶**: `rust/agentflow-core/src/database/version.rs`

```rust
pub struct SchemaVersion {
    pub version: i32,
    pub migrated_at: chrono::DateTime<chrono::Utc>,
}

pub async fn get_schema_version(db: &SqlitePool) -> Result<i32> {
    let row = sqlx::query(
        "SELECT version FROM schema_version ORDER BY migrated_at DESC LIMIT 1"
    )
    .fetch_one(db)
    .await?;

    Ok(row.get("version"))
}

pub async fn set_schema_version(db: &SqlitePool, version: i32) -> Result<()> {
    sqlx::query(
        "INSERT INTO schema_version (version, migrated_at)
         VALUES (?1, ?2)"
    )
    .bind(version)
    .bind(chrono::Utc::now())
    .execute(db)
    .await?;

    Ok(())
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… Migration è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- âœ… æ‰€æœ‰è¡¨æ·»åŠ  `project_id` å­—æ®µ
- âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ
- âœ… æ•°æ®è®¿é—®å±‚æ›´æ–°å®Œæˆ

---

### Phase 3: é¡¹ç›®å‘ç°ä¸è½»é‡åŒ–é…ç½®
**å·¥æœŸ**: 1-2 å¤©
**ä¼˜å…ˆçº§**: P0
**ä¾èµ–**: Phase 2

#### ä»»åŠ¡æ¸…å•

**Task 3.1: å®ç°é¡¹ç›®ä¸Šä¸‹æ–‡**
**æ–‡ä»¶**: `rust/agentflow-core/src/project/context.rs`

```rust
use std::path::PathBuf;
use serde::{Deserialize, Serialize};
use anyhow::Result;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ProjectContext {
    pub id: String,
    pub root_path: PathBuf,
    pub name: String,
    pub config: ProjectConfig,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ProjectConfig {
    pub allowed_branches: Vec<String>,
    pub skills: Vec<String>,
}

impl ProjectContext {
    /// ä»å½“å‰å·¥ä½œç›®å½•å‘ä¸ŠæŸ¥æ‰¾ .agentflow/project.toml
    pub fn discover(cwd: PathBuf) -> Option<Self> {
        let mut current = cwd.clone();

        loop {
            let config_path = current.join(".agentflow/project.toml");

            if config_path.exists() {
                return Some(Self::from_config(&config_path, current));
            }

            // åˆ°è¾¾æ ¹ç›®å½•ï¼Œæœªæ‰¾åˆ°
            if current.parent().is_none() {
                break;
            }

            current = current.parent()?.to_path_buf();
        }

        None
    }

    /// ä»é…ç½®æ–‡ä»¶åŠ è½½
    fn from_config(config_path: &PathBuf, root_path: PathBuf) -> Self {
        let content = std::fs::read_to_string(config_path)
            .unwrap_or_else(|_| "".to_string());

        let config: ProjectConfig = toml::from_str(&content)
            .unwrap_or_else(|_| ProjectConfig::default());

        let id = std::path::PathBuf::from(&root_path)
            .file_name()
            .and_then(|n| n.to_str())
            .unwrap_or("unknown")
            .to_string();

        let name = config.name.clone();

        Self { id, root_path, name, config }
    }

    /// å¦‚æœæœªæ‰¾åˆ°é…ç½®ï¼Œä½¿ç”¨è·¯å¾„å“ˆå¸Œä½œä¸º ID
    pub fn fallback(cwd: PathBuf) -> Self {
        use std::collections::hash_map::DefaultHasher;
        use std::hash::{Hash, Hasher};

        let mut hasher = DefaultHasher::new();
        cwd.hash(&mut hasher);
        let id = format!("temp-{:x}", hasher.finish());

        Self {
            id,
            root_path: cwd,
            name: "Unnamed".to_string(),
            config: ProjectConfig::default(),
        }
    }
}

impl Default for ProjectConfig {
    fn default() -> Self {
        Self {
            allowed_branches: vec!["main".to_string(), "dev".to_string()],
            skills: vec![],
        }
    }
}
```

**Task 3.2: åˆ›å»ºé…ç½®æ¨¡æ¿**
**æ–‡ä»¶**: `templates/project.toml.example`

```toml
[project]
id = "my-project-main"          # å”¯ä¸€æ ‡è¯†
name = "My Project"

[agent]
allowed_branches = ["main", "dev"]
skills = []

[build]
system = "cargo"                 # cargo | npm | msbuild | make

[test]
command = "cargo test"
```

**Task 3.3: å•å…ƒæµ‹è¯•**
```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_fallback_context() {
        let cwd = PathBuf::from("/tmp/test-project");
        let ctx = ProjectContext::fallback(cwd);

        assert_eq!(ctx.name, "Unnamed");
        assert!(ctx.id.starts_with("temp-"));
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… é¡¹ç›®å‘ç°é€»è¾‘æ­£ç¡®
- âœ… é…ç½®æ–‡ä»¶æ ¼å¼åˆç†
- âœ… fallback æœºåˆ¶æœ‰æ•ˆ

---

### Phase 4: æŠ€èƒ½å®‰è£…ä¸ç¯å¢ƒæ£€æµ‹æç¤º
**å·¥æœŸ**: 1 å¤©
**ä¼˜å…ˆçº§**: P1
**ä¾èµ–**: Phase 3

#### ä»»åŠ¡æ¸…å•

**Task 4.1: å®ç°ç¯å¢ƒæ£€æµ‹**
**æ–‡ä»¶**: `rust/agentflow-cli/src/commands/skill.rs`

```rust
use crate::paths::AgentFlowPaths;

pub fn execute(args: InstallArgs) -> Result<()> {
    // 1. åˆå§‹åŒ–å…¨å±€ç›®å½•
    AgentFlowPaths::ensure()?;

    // 2. æ£€æµ‹æ—§ç»“æ„
    let local_db = std::path::PathBuf::from(".agentflow/agentflow.db");
    if local_db.exists() {
        println!("âš ï¸  æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬çš„é¡¹ç›®æ•°æ®ç»“æ„ã€‚");
        println!();
        println!("æ—§ç‰ˆæœ¬æ•°æ®ä½ç½®: .agentflow/agentflow.db");
        println!("æ–°ç‰ˆæœ¬æ•°æ®ä½ç½®: ~/.agentflow/agentflow.db");
        println!();
        println!("å»ºè®®è¿è¡Œè¿ç§»å‘½ä»¤:");
        println!("  agentflow admin migrate");
        println!();
        print!("æ˜¯å¦ç»§ç»­å®‰è£…æŠ€èƒ½ï¼Ÿ[y/N] ");

        let mut input = String::new();
        std::io::stdin().read_line(&mut input)?;
        if !input.trim().to_lowercase().starts_with('y') {
            return Ok(());
        }
    }

    // 3. ç»§ç»­æ­£å¸¸çš„æŠ€èƒ½å®‰è£…é€»è¾‘
    install_skill(args)?;

    Ok(())
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ£€æµ‹é€»è¾‘æ­£ç¡®
- âœ… æç¤ºä¿¡æ¯æ¸…æ™°
- âœ… ç”¨æˆ·å¯ä»¥é€‰æ‹©ç»§ç»­æˆ–ç»ˆæ­¢

---

### Phase 5: æ‰§è¡Œå™¨æ”¹é€ 
**å·¥æœŸ**: 2-3 å¤©
**ä¼˜å…ˆçº§**: P1
**ä¾èµ–**: Phase 3

#### ä»»åŠ¡æ¸…å•

**Task 5.1: ä¿®æ”¹ TaskExecutor**
**æ–‡ä»¶**: `rust/agentflow-core/src/executor/mod.rs`

```rust
use crate::project::ProjectContext;

impl TaskExecutor {
    /// æ‰§è¡Œä»»åŠ¡ï¼ˆæ”¯æŒå¤šé¡¹ç›®ï¼‰
    pub async fn execute_with_project(
        &self,
        prompt: &str,
        project_ctx: &ProjectContext,
    ) -> Result<ExecutionResult> {
        // 1. ä¿å­˜å½“å‰ç›®å½•
        let original_dir = std::env::current_dir()?;

        // 2. åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
        std::env::set_current_dir(&project_ctx.root_path)?;

        info!(
            project = %project_ctx.id,
            path = %project_ctx.root_path.display(),
            "åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•"
        );

        // 3. æ‰§è¡Œ CLI
        let result = self.execute_cli(prompt).await;

        // 4. æ¢å¤ç›®å½•
        std::env::set_current_dir(original_dir)?;

        result
    }
}
```

**Task 5.2: é›†æˆé¡¹ç›®ä¸Šä¸‹æ–‡**
```rust
pub async fn execute(&self, prompt: &str) -> Result<ExecutionResult> {
    // 1. å‘ç°é¡¹ç›®ä¸Šä¸‹æ–‡
    let cwd = std::env::current_dir()?;
    let project_ctx = ProjectContext::discover(cwd)
        .unwrap_or_else(|| ProjectContext::fallback(cwd));

    // 2. æ‰§è¡Œä»»åŠ¡
    self.execute_with_project(prompt, &project_ctx).await
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒå¤šé¡¹ç›®æ‰§è¡Œ
- âœ… ç›®å½•åˆ‡æ¢æ­£ç¡®
- âœ… Git æ“ä½œåœ¨æ­£ç¡®çš„ä»“åº“

---

### Phase 6: æ•°æ®è¿ç§»å·¥å…·
**å·¥æœŸ**: 2-3 å¤©
**ä¼˜å…ˆçº§**: P2
**ä¾èµ–**: Phase 2

#### ä»»åŠ¡æ¸…å•

**Task 6.1: å®ç°è¿ç§»å‘½ä»¤**
**æ–‡ä»¶**: `rust/agentflow-cli/src/commands/admin.rs`

```rust
pub struct MigrateArgs {
    pub source: Option<String>,  // æºç›®å½•ï¼Œé»˜è®¤å½“å‰ç›®å½•
    pub backup: bool,            // æ˜¯å¦å¤‡ä»½ï¼Œé»˜è®¤ true
}

pub fn execute(args: MigrateArgs) -> Result<()> {
    // 1. ç¡®å®šæºç›®å½•
    let source_dir = args.source
        .map(PathBuf::from)
        .unwrap_or_else(|| std::env::current_dir()?);

    // 2. æŸ¥æ‰¾æ—§æ•°æ®åº“
    let old_db = source_dir.join(".agentflow/agentflow.db");
    if !old_db.exists() {
        println!("æœªæ‰¾åˆ°æ—§ç‰ˆæœ¬æ•°æ®åº“: {}", old_db.display());
        return Ok(());
    }

    // 3. å¤‡ä»½
    if args.backup {
        let backup_path = format!("{}.bak", old_db.display());
        std::fs::copy(&old_db, &backup_path)?;
        println!("å·²å¤‡ä»½æ—§æ•°æ®åº“: {}", backup_path);
    }

    // 4. è¯»å– project.toml ç”Ÿæˆ project_id
    let config_file = source_dir.join(".agentflow/project.toml");
    let project_id = if config_file.exists() {
        let config: ProjectConfig = std::fs::read_to_string(&config_file)?;
        config.id
    } else {
        source_dir
            .file_name()
            .and_then(|n| n.to_str())
            .unwrap_or("unknown")
            .to_string()
    };

    // 5. è¿ç§»æ•°æ®
    println!("æ­£åœ¨è¿ç§»æ•°æ®...");
    println!("  æº: {}", old_db.display());
    println!("  ç›®æ ‡: {}", AgentFlowPaths::main_db().display());
    println!("  é¡¹ç›® ID: {}", project_id);

    // TODO: å®é™…çš„æ•°æ®è¿ç§»é€»è¾‘
    // - è¯»å–æ—§æ•°æ®åº“
    // - ä¸ºæ¯æ¡è®°å½•æ·»åŠ  project_id
    // - å†™å…¥æ–°æ•°æ®åº“

    // 6. å®Œæˆ
    println!("âœ… è¿ç§»å®Œæˆï¼");
    println!();
    println!("ä¸‹ä¸€æ­¥:");
    println!("  1. éªŒè¯æ•°æ®: agentflow query tasks");
    println!("  2. åˆ é™¤æ—§æ•°æ®: rm -rf .agentflow/agentflow.db");

    Ok(())
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿ç§»é€»è¾‘æ­£ç¡®
- âœ… è‡ªåŠ¨å¤‡ä»½æ—§æ•°æ®
- âœ… project_id ç”Ÿæˆæ­£ç¡®

---

## æµ‹è¯•è®¡åˆ’

### åŠŸèƒ½æµ‹è¯•

**Test 1: å…¨å±€å®‰è£…**
```bash
cargo install --path .
cd /tmp
agentflow --version  # åº”è¯¥æˆåŠŸ
```

**Test 2: é¡¹ç›®åˆå§‹åŒ–**
```bash
cd ~/code/MyProject
agentflow skill init
# éªŒè¯: ~/.agentflow/agentflow.db å­˜åœ¨
# éªŒè¯: .agentflow/project.toml å­˜åœ¨
```

**Test 3: å¤šé¡¹ç›®éš”ç¦»**
```bash
cd ~/code/ProjectA
agentflow run "æµ‹è¯• A"

cd ~/code/ProjectB
agentflow run "æµ‹è¯• B"

# éªŒè¯: ä¸¤ä¸ªé¡¹ç›®çš„æ•°æ®ç‹¬ç«‹
agentflow query tasks | grep "project_id"
```

**Test 4: æ•°æ®è¿ç§»**
```bash
cd ~/old-project
agentflow admin migrate
# éªŒè¯: æ•°æ®å®Œæ•´æ€§
# éªŒè¯: project_id æ­£ç¡®
```

### æ€§èƒ½æµ‹è¯•

- å•é¡¹ç›®æŸ¥è¯¢ < 100ms
- å¤šé¡¹ç›®ç»Ÿè®¡ < 500ms
- æ•°æ®åº“å¤§å° < 100MB (1000 ä»»åŠ¡)

---

## é£é™©ä¸åº”å¯¹

| é£é™© | çº§åˆ« | åº”å¯¹æªæ–½ |
|------|------|----------|
| **æ•°æ®è¿ç§»å¤±è´¥** | ğŸ”´ é«˜ | è‡ªåŠ¨å¤‡ä»½ + è¿ç§»æµ‹è¯• + å›æ»šæœºåˆ¶ |
| **ç”¨æˆ·ä¸é€‚åº”** | ğŸŸ¡ ä¸­ | æ¸è¿›å¼æç¤º + è¯¦ç»†æ–‡æ¡£ + å…¼å®¹æ—§ç‰ˆæœ¬ |
| **æ€§èƒ½ä¸‹é™** | ğŸŸ¡ ä¸­ | ç´¢å¼•ä¼˜åŒ– + æŸ¥è¯¢ä¼˜åŒ– + æ€§èƒ½æµ‹è¯• |
| **Breaking Changes** | ğŸŸ¡ ä¸­ | ç‰ˆæœ¬å·ç®¡ç† + è¿ç§»æ£€æŸ¥ + è­¦å‘Šæç¤º |

---

## äº¤ä»˜æ¸…å•

### ä»£ç äº¤ä»˜

- [ ] `rust/agentflow-core/src/paths.rs` - è·¯å¾„ç®¡ç†æ¨¡å—
- [ ] `rust/agentflow-core/src/database/migrations.rs` - Migration è„šæœ¬
- [ ] `rust/agentflow-core/src/database/version.rs` - ç‰ˆæœ¬ç®¡ç†
- [ ] `rust/agentflow-core/src/project/context.rs` - é¡¹ç›®ä¸Šä¸‹æ–‡
- [ ] `rust/agentflow-core/src/executor/mod.rs` (ä¿®æ”¹) - æ‰§è¡Œå™¨æ”¹é€ 
- [ ] `rust/agentflow-cli/src/commands/admin.rs` - ç®¡ç†å‘½ä»¤
- [ ] `rust/agentflow-cli/src/commands/skill.rs` (ä¿®æ”¹) - ç¯å¢ƒæ£€æµ‹

### æ–‡æ¡£äº¤ä»˜

- [ ] `docs/ARCHITECTURE.md` - æ–°æ¶æ„è¯´æ˜
- [ ] `docs/MIGRATION_GUIDE.md` - è¿ç§»æŒ‡å—
- [ ] `docs/PROJECT_CONFIG.md` - é¡¹ç›®é…ç½®è¯´æ˜
- [ ] `CHANGELOG.md` - å˜æ›´æ—¥å¿—

### æµ‹è¯•äº¤ä»˜

- [ ] å•å…ƒæµ‹è¯• (è¦†ç›–ç‡ > 80%)
- [ ] é›†æˆæµ‹è¯• (å¤šé¡¹ç›®åœºæ™¯)
- [ ] è¿ç§»æµ‹è¯• (æ—§ç‰ˆæœ¬ â†’ v0.4.0)
- [ ] æ€§èƒ½æµ‹è¯• (æŸ¥è¯¢å“åº”æ—¶é—´)

---

## æ—¶é—´çº¿

```
Week 1 (Day 1-7):
  Phase 1: è·¯å¾„ç®¡ç† (1-2 å¤©)
  Phase 2: Schema å‡çº§ (2-3 å¤©)
  Phase 3: é¡¹ç›®å‘ç° (1-2 å¤©)

Week 2 (Day 8-14):
  Phase 4: ç¯å¢ƒæ£€æµ‹ (1 å¤©)
  Phase 5: æ‰§è¡Œå™¨æ”¹é€  (2-3 å¤©)
  é›†æˆæµ‹è¯• (2 å¤©)

Week 3 (Day 15-20):
  Phase 6: æ•°æ®è¿ç§»å·¥å…· (2-3 å¤©)
  æ–‡æ¡£ç¼–å†™ (2 å¤©)
  å‘å¸ƒå‡†å¤‡ (1 å¤©)
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åš

1. **åˆ›å»ºå¼€å‘åˆ†æ”¯**
   ```bash
   git checkout -b feature/0.4.0-refactor
   ```

2. **å¯åŠ¨ Phase 1**
   - æ·»åŠ  `dirs` ä¾èµ–
   - å®ç° `AgentFlowPaths` æ¨¡å—
   - å•å…ƒæµ‹è¯•

3. **å¹¶è¡Œä»»åŠ¡**
   - è®¾è®¡ Migration è„šæœ¬
   - è®¾è®¡ project.toml æ ¼å¼

---

**æœ€åæ›´æ–°**: 2026-01-28
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**çŠ¶æ€**: å¾…å¯åŠ¨
