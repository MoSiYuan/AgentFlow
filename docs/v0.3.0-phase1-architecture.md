# Webhook Server æ¶æ„æ¦‚è§ˆ

## ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AgentFlow Master Server                   â”‚
â”‚                         (Axum + Tokio)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                              â”‚
                              â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP API Routes       â”‚         â”‚   Webhook Routes         â”‚
â”‚   /api/v1/tasks         â”‚         â”‚   /api/v1/webhook/zhipu  â”‚
â”‚   /api/v1/memory        â”‚         â”‚                          â”‚
â”‚   /ws/task/:id          â”‚         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚  Zhipu Handler   â”‚   â”‚
                                    â”‚   â”‚  - Intent Parse  â”‚   â”‚
                                    â”‚   â”‚  - Task Dispatch â”‚   â”‚
                                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                    â”‚           â”‚              â”‚
                                    â”‚           â–¼              â”‚
                                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                    â”‚   â”‚  Auth Middleware â”‚   â”‚
                                    â”‚   â”‚  - Bearer Token  â”‚   â”‚
                                    â”‚   â”‚  - IP Whitelist  â”‚   â”‚
                                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµå›¾

```
æ™ºè°±æ¸…è¨€æ™ºèƒ½ä½“
      â”‚
      â”‚ 1. POST /api/v1/webhook/zhipu
      â”‚    { "text": "åˆ›å»ºæµ‹è¯•ä»»åŠ¡" }
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Axum Routerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ 2. é‰´æƒä¸­é—´ä»¶ï¼ˆå¯é€‰ï¼‰
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Zhipu Handlerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€ 3a. è§£ææ„å›¾ (MVP: å…³é”®è¯åŒ¹é…)
      â”‚     "åˆ›å»º" â†’ create_task
      â”‚
      â”œâ”€ 3b. è®°å½•æ—¥å¿—
      â”‚     INFO: æ”¶åˆ°æŒ‡ä»¤: åˆ›å»ºæµ‹è¯•ä»»åŠ¡
      â”‚
      â””â”€ 3c. è¿”å›å“åº”
            {
              "task_id": "mock-task-uuid",
              "status": "dispatched",
              "message": "æ”¶åˆ°æŒ‡ä»¤: åˆ›å»ºæµ‹è¯•ä»»åŠ¡"
            }
```

## æ¨¡å—ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              main.rs                         â”‚
â”‚  - å¯åŠ¨æœåŠ¡å™¨                                 â”‚
â”‚  - æ³¨å†Œè·¯ç”±                                   â”‚
â”‚  - åˆå§‹åŒ–çŠ¶æ€                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  routes/      â”‚       â”‚  webhook/    â”‚
â”‚  - tasks      â”‚       â”‚  - mod.rs    â”‚
â”‚  - memory     â”‚       â”‚  - auth.rs   â”‚
â”‚  - health     â”‚       â”‚  - zhipu.rs  â”‚
â”‚  - websocket  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   AppState           â”‚
        â”‚   - executor         â”‚
        â”‚   - memory           â”‚
        â”‚   - start_time       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–‡ä»¶ç»„ç»‡ç»“æ„

```
agentflow-master/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ webhook/              â† æ–°å¢æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs           (21 è¡Œ)   - è·¯ç”±å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ auth.rs          (243 è¡Œ)  - é‰´æƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ zhipu.rs         (263 è¡Œ)  - æ™ºè°±å¤„ç†
â”‚   â”‚   â””â”€â”€ README.md        (æ–‡æ¡£)    - æ¨¡å—æ–‡æ¡£
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/               - ç°æœ‰è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ tasks.rs
â”‚   â”‚   â”œâ”€â”€ memory.rs
â”‚   â”‚   â”œâ”€â”€ health.rs
â”‚   â”‚   â””â”€â”€ websocket.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ lib.rs               â† ä¿®æ”¹ï¼šæ·»åŠ  webhook æ¨¡å—
â”‚   â”œâ”€â”€ main.rs              â† ä¿®æ”¹ï¼šé›†æˆ webhook è·¯ç”±
â”‚   â”œâ”€â”€ config.rs
â”‚   â”œâ”€â”€ error.rs
â”‚   â”œâ”€â”€ executor.rs
â”‚   â””â”€â”€ memory_core.rs
â”‚
â””â”€â”€ Cargo.toml
```

## ä»£ç ç»Ÿè®¡

| æ¨¡å— | æ–‡ä»¶ | è¡Œæ•° | æµ‹è¯• | è¯´æ˜ |
|------|------|------|------|------|
| webhook | mod.rs | 21 | - | è·¯ç”±å®šä¹‰ |
| webhook | auth.rs | 243 | 5 | é‰´æƒä¸­é—´ä»¶ |
| webhook | zhipu.rs | 263 | 8 | æ™ºè°±å¤„ç† |
| **æ€»è®¡** | **3 æ–‡ä»¶** | **527** | **13** | **æ ¸å¿ƒä»£ç ** |

## API ç«¯ç‚¹æ¸…å•

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | çŠ¶æ€ |
|------|------|------|------|
| /health | GET | å¥åº·æ£€æŸ¥ | âœ… |
| /api/v1/health | GET | å¥åº·æ£€æŸ¥ | âœ… |
| /api/v1/tasks | POST/GET | ä»»åŠ¡ç®¡ç† | âœ… |
| /api/v1/tasks/:id | GET/DELETE | ä»»åŠ¡è¯¦æƒ… | âœ… |
| /api/v1/tasks/:id/execute | POST | æ‰§è¡Œä»»åŠ¡ | âœ… |
| /api/v1/tasks/:id/cancel | POST | å–æ¶ˆä»»åŠ¡ | âœ… |
| /api/v1/memory/search | GET/POST | è®°å¿†æœç´¢ | âœ… |
| /api/v1/memory/:key | GET/DELETE | è®°å¿†ç®¡ç† | âœ… |
| /api/v1/memory/stats | GET | è®°å¿†ç»Ÿè®¡ | âœ… |
| /ws/task/:id | WS | WebSocket | âœ… |
| **/api/v1/webhook/zhipu** | **POST** | **æ™ºè°±æ¸…è¨€** | **ğŸ†•** |

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

```
auth.rs (5 ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_verify_success              âœ… Token éªŒè¯æˆåŠŸ
â”œâ”€â”€ test_verify_missing_header       âœ… ç¼ºå°‘ Authorization å¤´
â”œâ”€â”€ test_verify_wrong_token          âœ… Token å€¼é”™è¯¯
â””â”€â”€ test_verify_invalid_format       âœ… Token æ ¼å¼é”™è¯¯

zhipu.rs (8 ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_zhipu_webhook_request_deserialize    âœ… è¯·æ±‚ååºåˆ—åŒ–
â”œâ”€â”€ test_zhipu_webhook_request_without_session âœ… æ—  session_id
â”œâ”€â”€ test_zhipu_webhook_response_serialize     âœ… å“åº”åºåˆ—åŒ–
â”œâ”€â”€ test_parse_intent_mock_create             âœ… åˆ›å»ºæ„å›¾
â”œâ”€â”€ test_parse_intent_mock_execute            âœ… æ‰§è¡Œæ„å›¾
â”œâ”€â”€ test_parse_intent_mock_query              âœ… æŸ¥è¯¢æ„å›¾
â”œâ”€â”€ test_parse_intent_mock_delete             âœ… åˆ é™¤æ„å›¾
â””â”€â”€ test_parse_intent_mock_unknown            âœ… æœªçŸ¥æ„å›¾
```

### é›†æˆæµ‹è¯•

```
webhook_test.sh (6 ä¸ªåœºæ™¯)
â”œâ”€â”€ æµ‹è¯• 1: åŸºæœ¬ Webhook è¯·æ±‚              âœ…
â”œâ”€â”€ æµ‹è¯• 2: å¸¦ session_id çš„è¯·æ±‚           âœ…
â”œâ”€â”€ æµ‹è¯• 3: ä¸åŒæŒ‡ä»¤ç±»å‹æµ‹è¯•               âœ…
â”œâ”€â”€ æµ‹è¯• 4: é‰´æƒæµ‹è¯•                       âœ…
â”œâ”€â”€ æµ‹è¯• 5: é”™è¯¯è¯·æ±‚æµ‹è¯•                   âœ…
â””â”€â”€ æµ‹è¯• 6: è¯¦ç»†è¾“å‡ºæµ‹è¯•                   âœ…
```

## æŠ€æœ¯æ ˆæ€»è§ˆ

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| Web æ¡†æ¶ | Axum | 0.7 | HTTP æœåŠ¡å™¨ |
| å¼‚æ­¥è¿è¡Œæ—¶ | Tokio | 1.x | å¼‚æ­¥å¤„ç† |
| åºåˆ—åŒ– | Serde | 1.0 | JSON å¤„ç† |
| æ—¥å¿— | Tracing | 0.1 | ç»“æ„åŒ–æ—¥å¿— |
| æ•°æ®åº“ | SQLx | 0.7 | SQLite |
| UUID | Uuid | 1.0 | å”¯ä¸€æ ‡è¯†ç¬¦ |

## å¼€å‘å·¥ä½œæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å‘æ–°åŠŸèƒ½     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç¼–è¾‘ä»£ç       â”‚
â”‚    - åˆ›å»ºæ¨¡å—    â”‚
â”‚    - å®ç°é€»è¾‘    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç¼–å†™æµ‹è¯•      â”‚
â”‚    - å•å…ƒæµ‹è¯•    â”‚
â”‚    - é›†æˆæµ‹è¯•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è¿è¡Œæµ‹è¯•      â”‚
â”‚    cargo test    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç¼–è¯‘æ£€æŸ¥      â”‚
â”‚    cargo build   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ–‡æ¡£æ›´æ–°      â”‚
â”‚    - Rust Doc    â”‚
â”‚    - README      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æäº¤ä»£ç       â”‚
â”‚    git commit    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ€§èƒ½æŒ‡æ ‡ï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| å“åº”æ—¶é—´ | < 100ms | MVP é˜¶æ®µ |
| ååé‡ | > 100 req/s | å•æœºæµ‹è¯• |
| å¹¶å‘è¿æ¥ | > 1000 | Tokio æ”¯æŒ |
| å†…å­˜å ç”¨ | < 100MB | åŸºç¡€æœåŠ¡ |

## å®‰å…¨è€ƒè™‘

### MVP é˜¶æ®µ
- âœ… Bearer Token é‰´æƒï¼ˆå¯é€‰ï¼‰
- âœ… è¯·æ±‚æ—¥å¿—è®°å½•
- âœ… é”™è¯¯ä¿¡æ¯è„±æ•

### åç»­å¢å¼º
- â³ IP ç™½åå•éªŒè¯
- â³ è¯·æ±‚ç­¾åéªŒè¯
- â³ é€Ÿç‡é™åˆ¶
- â³ HTTPS å¼ºåˆ¶

## ç›‘æ§æŒ‡æ ‡ï¼ˆå»ºè®®ï¼‰

```rust
// å»ºè®®æ·»åŠ çš„ç›‘æ§æŒ‡æ ‡
- webhook_requests_total           // æ€»è¯·æ±‚æ•°
- webhook_requests_duration_ms     // è¯·æ±‚è€—æ—¶
- webhook_requests_success         // æˆåŠŸè¯·æ±‚æ•°
- webhook_requests_errors          // é”™è¯¯è¯·æ±‚æ•°
- webhook_intent_parse_success     // æ„å›¾è§£ææˆåŠŸ
- webhook_task_dispatched          // ä»»åŠ¡åˆ†å‘æ•°
```

## é…ç½®æ–‡ä»¶

```bash
# .env æ–‡ä»¶ç¤ºä¾‹
WEBHOOK_SECRET=your_secure_secret
DATABASE_URL=sqlite:///agentflow.db
RUST_LOG=info
SERVER_ADDR=0.0.0.0
SERVER_PORT=6767
```

---

**æ¶æ„ç‰ˆæœ¬**: v0.3.0 Phase 1
**æœ€åæ›´æ–°**: 2026-01-28
**çŠ¶æ€**: âœ… MVP å®Œæˆ
