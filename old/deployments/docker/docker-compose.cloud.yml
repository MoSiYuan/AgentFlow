version: '3.8'

services:
  cpds-master:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
    container_name: cpds-master-cloud
    restart: always
    ports:
      - "8848:8848"
    environment:
      - CPDS_MODE=cloud
      - CPDS_CLAUDE_API_KEY=${CLAUDE_API_KEY}
    volumes:
      - ./data/cloud:/app/.claude/cpds-manager
    command: ["master", "--mode", "cloud", "--host", "0.0.0.0"]
    networks:
      - cpds-cloud

  cpds-worker:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
    depends_on:
      - cpds-master
    restart: always
    environment:
      - CPDS_MODE=cloud
      - CPDS_CLAUDE_API_KEY=${CLAUDE_API_KEY}
    volumes:
      - ./data/cloud:/app/.claude/cpds-manager
    command: ["worker", "--mode", "cloud", "--master", "http://cpds-master:8848", "--auto"]
    deploy:
      replicas: 3  # 3 workers by default
    networks:
      - cpds-cloud

networks:
  cpds-cloud:
    driver: bridge
